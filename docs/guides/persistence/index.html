<!DOCTYPE html><!--05bjYGyiAumoEMBrfWHih--><html lang="en"><head><meta charSet="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/><link rel="preload" href="/_next/static/media/4cf2300e9c8272f7-s.p.woff2" as="font" crossorigin="" type="font/woff2"/><link rel="preload" href="/_next/static/media/93f479601ee12b01-s.p.woff2" as="font" crossorigin="" type="font/woff2"/><link rel="stylesheet" href="/_next/static/css/4bd7a24b7976d4e6.css" data-precedence="next"/><link rel="preload" as="script" fetchPriority="low" href="/_next/static/chunks/webpack-bd6546b43ab2ecbf.js"/><script src="/_next/static/chunks/4bd1b696-deba172d32c79f82.js" async=""></script><script src="/_next/static/chunks/794-275dc9ebd3a29fbf.js" async=""></script><script src="/_next/static/chunks/main-app-1fa5b694e5d36a75.js" async=""></script><script src="/_next/static/chunks/app/layout-7e9963bf811be36b.js" async=""></script><script src="/_next/static/chunks/758-3cb69ce377cde046.js" async=""></script><script src="/_next/static/chunks/121-aece4f809b101dc1.js" async=""></script><script src="/_next/static/chunks/502-e809071f8789437b.js" async=""></script><script src="/_next/static/chunks/689-4fcf9680fdc90283.js" async=""></script><script src="/_next/static/chunks/app/docs/%5B%5B...slug%5D%5D/page-004ec69e3c86920a.js" async=""></script><meta name="next-size-adjust" content=""/><title>InputLayer - A symbolic reasoning engine for AI agents</title><meta name="description" content="Store facts, define rules, and derive everything that logically follows. Vector search, graph traversal, and incremental computation in one system."/><link rel="icon" href="/icon.svg"/><script src="/_next/static/chunks/polyfills-42372ed130431b0a.js" noModule=""></script></head><body class="__variable_188709 __variable_9a8899 font-sans antialiased"><div hidden=""><!--$--><!--/$--></div><script>((a,b,c,d,e,f,g,h)=>{let i=document.documentElement,j=["light","dark"];function k(b){var c;(Array.isArray(a)?a:[a]).forEach(a=>{let c="class"===a,d=c&&f?e.map(a=>f[a]||a):e;c?(i.classList.remove(...d),i.classList.add(f&&f[b]?f[b]:b)):i.setAttribute(a,b)}),c=b,h&&j.includes(c)&&(i.style.colorScheme=c)}if(d)k(d);else try{let a=localStorage.getItem(b)||c,d=g&&"system"===a?window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light":a;k(d)}catch(a){}})("class","theme","dark",null,["light","dark"],null,true,true)</script><div class="flex flex-col h-dvh"><header class="sticky top-0 z-50 w-full border-b border-border/50 bg-background/95 backdrop-blur supports-[backdrop-filter]:bg-background/60"><div class="flex h-14 items-center px-6"><a class="mr-8" href="/"><span class="inline-flex items-center gap-1.5"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="flex-shrink-0"><path d="M12 2L2 7l10 5 10-5-10-5z"></path><path d="M2 17l10 5 10-5"></path><path d="M2 12l10 5 10-5"></path></svg><span class="font-extrabold tracking-tight text-lg">InputLayer</span></span></a><nav class="hidden md:flex items-center gap-6 text-sm"><a class="text-muted-foreground transition-colors hover:text-foreground" href="/docs/">Docs</a><a class="text-muted-foreground transition-colors hover:text-foreground" href="/blog/">Blog</a><a class="text-muted-foreground transition-colors hover:text-foreground" href="/use-cases/">Use Cases</a><a class="text-muted-foreground transition-colors hover:text-foreground" href="/compare/">Compare</a><a href="https://demo.inputlayer.ai" target="_blank" rel="noopener noreferrer" class="inline-flex items-center gap-1 text-muted-foreground transition-colors hover:text-foreground">Demo<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-external-link h-3 w-3"><path d="M15 3h6v6"></path><path d="M10 14 21 3"></path><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path></svg></a></nav><div class="ml-auto flex items-center gap-3"><div class="inline-flex items-center gap-1.5"><a href="https://github.com/inputlayer/inputlayer" target="_blank" rel="noopener noreferrer" class="inline-flex items-center gap-1.5 rounded-md border border-border bg-secondary/50 px-2.5 py-1 text-xs font-medium text-muted-foreground transition-colors hover:text-foreground hover:bg-secondary"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-star h-3.5 w-3.5"><path d="M11.525 2.295a.53.53 0 0 1 .95 0l2.31 4.679a2.123 2.123 0 0 0 1.595 1.16l5.166.756a.53.53 0 0 1 .294.904l-3.736 3.638a2.123 2.123 0 0 0-.611 1.878l.882 5.14a.53.53 0 0 1-.771.56l-4.618-2.428a2.122 2.122 0 0 0-1.973 0L6.396 21.01a.53.53 0 0 1-.77-.56l.881-5.139a2.122 2.122 0 0 0-.611-1.879L2.16 9.795a.53.53 0 0 1 .294-.906l5.165-.755a2.122 2.122 0 0 0 1.597-1.16z"></path></svg><span>Star</span></a><a href="https://github.com/inputlayer/inputlayer/fork" target="_blank" rel="noopener noreferrer" class="inline-flex items-center gap-1.5 rounded-md border border-border bg-secondary/50 px-2.5 py-1 text-xs font-medium text-muted-foreground transition-colors hover:text-foreground hover:bg-secondary"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-git-fork h-3.5 w-3.5"><circle cx="12" cy="18" r="3"></circle><circle cx="6" cy="6" r="3"></circle><circle cx="18" cy="6" r="3"></circle><path d="M18 9v2c0 .6-.4 1-1 1H7c-.6 0-1-.4-1-1V9"></path><path d="M12 12v3"></path></svg><span>Fork</span></a></div><button data-slot="button" class="inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-md text-sm font-medium transition-all disabled:pointer-events-none disabled:opacity-50 [&amp;_svg]:pointer-events-none [&amp;_svg:not([class*=&#x27;size-&#x27;])]:size-4 shrink-0 [&amp;_svg]:shrink-0 outline-none focus-visible:border-ring focus-visible:ring-ring/50 focus-visible:ring-[3px] aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive hover:bg-accent hover:text-accent-foreground dark:hover:bg-accent/50 size-9 h-9 w-9"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-sun h-4 w-4"><circle cx="12" cy="12" r="4"></circle><path d="M12 2v2"></path><path d="M12 20v2"></path><path d="m4.93 4.93 1.41 1.41"></path><path d="m17.66 17.66 1.41 1.41"></path><path d="M2 12h2"></path><path d="M20 12h2"></path><path d="m6.34 17.66-1.41 1.41"></path><path d="m19.07 4.93-1.41 1.41"></path></svg></button><div class="md:hidden"><button class="inline-flex items-center justify-center rounded-md p-2 text-muted-foreground hover:text-foreground hover:bg-secondary transition-colors" aria-label="Open menu"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-menu h-5 w-5"><line x1="4" x2="20" y1="12" y2="12"></line><line x1="4" x2="20" y1="6" y2="6"></line><line x1="4" x2="20" y1="18" y2="18"></line></svg></button></div></div></div></header><div class="flex flex-1 overflow-hidden"><div class="w-64 shrink-0 border-r border-border/50 overflow-y-auto"><div class="flex flex-col h-full"><div class="p-3 border-b border-border/50"><div class="relative"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-search absolute left-2.5 top-1/2 -translate-y-1/2 h-3.5 w-3.5 text-muted-foreground"><circle cx="11" cy="11" r="8"></circle><path d="m21 21-4.3-4.3"></path></svg><input type="text" placeholder="Search docs..." class="w-full h-8 pl-8 pr-3 text-sm rounded-md border border-border bg-background placeholder:text-muted-foreground focus:outline-none focus:ring-1 focus:ring-ring" value=""/></div></div><nav class="flex-1 overflow-y-auto p-2 space-y-0.5"><a class="block py-1.5 px-3 text-sm rounded-md transition-colors text-muted-foreground hover:bg-muted hover:text-foreground" style="padding-left:12px" href="/docs/index/">Overview</a><div data-state="open" data-slot="collapsible"><button class="w-full flex items-center w-full py-1.5 px-3 text-sm rounded-md transition-colors text-foreground font-medium" style="padding-left:12px" type="button" aria-controls="radix-_R_j6av5ubtb_" aria-expanded="true" data-state="open" data-slot="collapsible-trigger"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-chevron-right h-3.5 w-3.5 mr-1 shrink-0 transition-transform rotate-90"><path d="m9 18 6-6-6-6"></path></svg>Guides</button><div data-state="open" id="radix-_R_j6av5ubtb_" data-slot="collapsible-content"><a class="block py-1.5 px-3 text-sm rounded-md transition-colors text-muted-foreground hover:bg-muted hover:text-foreground" style="padding-left:24px" href="/docs/guides/quickstart/">Quick Start</a><a class="block py-1.5 px-3 text-sm rounded-md transition-colors text-muted-foreground hover:bg-muted hover:text-foreground" style="padding-left:24px" href="/docs/guides/installation/">Installation</a><a class="block py-1.5 px-3 text-sm rounded-md transition-colors text-muted-foreground hover:bg-muted hover:text-foreground" style="padding-left:24px" href="/docs/guides/first-program/">Your First Program</a><a class="block py-1.5 px-3 text-sm rounded-md transition-colors text-muted-foreground hover:bg-muted hover:text-foreground" style="padding-left:24px" href="/docs/guides/core-concepts/">Data Modeling</a><a class="block py-1.5 px-3 text-sm rounded-md transition-colors text-muted-foreground hover:bg-muted hover:text-foreground" style="padding-left:24px" href="/docs/guides/repl/">REPL Guide</a><a class="block py-1.5 px-3 text-sm rounded-md transition-colors text-muted-foreground hover:bg-muted hover:text-foreground" style="padding-left:24px" href="/docs/guides/recursion/">Recursion</a><a class="block py-1.5 px-3 text-sm rounded-md transition-colors text-muted-foreground hover:bg-muted hover:text-foreground" style="padding-left:24px" href="/docs/guides/vectors/">Vector Search</a><a class="block py-1.5 px-3 text-sm rounded-md transition-colors text-muted-foreground hover:bg-muted hover:text-foreground" style="padding-left:24px" href="/docs/guides/indexing/">Indexing</a><a class="block py-1.5 px-3 text-sm rounded-md transition-colors text-muted-foreground hover:bg-muted hover:text-foreground" style="padding-left:24px" href="/docs/guides/temporal/">Temporal Reasoning</a><a class="block py-1.5 px-3 text-sm rounded-md transition-colors bg-primary/10 text-primary font-medium" style="padding-left:24px" href="/docs/guides/persistence/">Persistence</a><a class="block py-1.5 px-3 text-sm rounded-md transition-colors text-muted-foreground hover:bg-muted hover:text-foreground" style="padding-left:24px" href="/docs/guides/configuration/">Configuration</a><a class="block py-1.5 px-3 text-sm rounded-md transition-colors text-muted-foreground hover:bg-muted hover:text-foreground" style="padding-left:24px" href="/docs/guides/rest-api/">REST API</a><a class="block py-1.5 px-3 text-sm rounded-md transition-colors text-muted-foreground hover:bg-muted hover:text-foreground" style="padding-left:24px" href="/docs/guides/python-sdk/">Python SDK</a><a class="block py-1.5 px-3 text-sm rounded-md transition-colors text-muted-foreground hover:bg-muted hover:text-foreground" style="padding-left:24px" href="/docs/guides/deployment/">Deployment</a><a class="block py-1.5 px-3 text-sm rounded-md transition-colors text-muted-foreground hover:bg-muted hover:text-foreground" style="padding-left:24px" href="/docs/guides/authentication/">Authentication</a><a class="block py-1.5 px-3 text-sm rounded-md transition-colors text-muted-foreground hover:bg-muted hover:text-foreground" style="padding-left:24px" href="/docs/guides/websocket-api/">WebSocket API</a><a class="block py-1.5 px-3 text-sm rounded-md transition-colors text-muted-foreground hover:bg-muted hover:text-foreground" style="padding-left:24px" href="/docs/guides/migrations/">Migrations</a><a class="block py-1.5 px-3 text-sm rounded-md transition-colors text-muted-foreground hover:bg-muted hover:text-foreground" style="padding-left:24px" href="/docs/guides/troubleshooting/">Troubleshooting</a></div></div><div data-state="closed" data-slot="collapsible"><button class="w-full flex items-center w-full py-1.5 px-3 text-sm rounded-md transition-colors text-muted-foreground hover:bg-muted hover:text-foreground" style="padding-left:12px" type="button" aria-controls="radix-_R_r6av5ubtb_" aria-expanded="false" data-state="closed" data-slot="collapsible-trigger"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-chevron-right h-3.5 w-3.5 mr-1 shrink-0 transition-transform"><path d="m9 18 6-6-6-6"></path></svg>Reference</button><div data-state="closed" id="radix-_R_r6av5ubtb_" hidden="" data-slot="collapsible-content"></div></div><div data-state="closed" data-slot="collapsible"><button class="w-full flex items-center w-full py-1.5 px-3 text-sm rounded-md transition-colors text-muted-foreground hover:bg-muted hover:text-foreground" style="padding-left:12px" type="button" aria-controls="radix-_R_136av5ubtb_" aria-expanded="false" data-state="closed" data-slot="collapsible-trigger"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-chevron-right h-3.5 w-3.5 mr-1 shrink-0 transition-transform"><path d="m9 18 6-6-6-6"></path></svg>Specification</button><div data-state="closed" id="radix-_R_136av5ubtb_" hidden="" data-slot="collapsible-content"></div></div><div data-state="closed" data-slot="collapsible"><button class="w-full flex items-center w-full py-1.5 px-3 text-sm rounded-md transition-colors text-muted-foreground hover:bg-muted hover:text-foreground" style="padding-left:12px" type="button" aria-controls="radix-_R_1b6av5ubtb_" aria-expanded="false" data-state="closed" data-slot="collapsible-trigger"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-chevron-right h-3.5 w-3.5 mr-1 shrink-0 transition-transform"><path d="m9 18 6-6-6-6"></path></svg>Internals</button><div data-state="closed" id="radix-_R_1b6av5ubtb_" hidden="" data-slot="collapsible-content"></div></div></nav></div></div><div class="flex flex-1 flex-col overflow-hidden"><div class="flex flex-1 overflow-hidden"><div class="flex-1 overflow-y-auto px-8 py-6 max-w-4xl mx-auto"><article class="docs-prose"><h1 id="persistence-guide" node="[object Object]">Persistence Guide</h1>
<p>InputLayer provides durable storage with crash recovery, using a combination of Write-Ahead Logging (WAL) and Parquet batch files.</p>
<h2 id="architecture-overview" node="[object Object]">Architecture Overview</h2>
<pre class="rounded-lg bg-[var(--code-bg)] p-4 overflow-x-auto mb-4 text-sm font-mono" node="[object Object]"><code class="bg-muted rounded px-1.5 py-0.5 font-mono text-sm" node="[object Object]">Insert/Delete
    ↓
Update{data, time, diff}
    ↓
WAL (immediate durability)
    ↓
In-memory buffer
    ↓ (when buffer full)
Batch file (Parquet)
</code></pre>
<h3 id="recovery-flow" node="[object Object]">Recovery Flow</h3>
<p>On startup, InputLayer:</p>
<ol>
<li>Loads shard metadata from disk</li>
<li>Reads batch files (Parquet)</li>
<li>Replays WAL (uncommitted updates)</li>
<li>Consolidates to get current state</li>
</ol>
<hr/>
<h2 id="directory-structure" node="[object Object]">Directory Structure</h2>
<pre class="rounded-lg bg-[var(--code-bg)] p-4 overflow-x-auto mb-4 text-sm font-mono" node="[object Object]"><code class="bg-muted rounded px-1.5 py-0.5 font-mono text-sm" node="[object Object]">data/
├── persist/
│   ├── shards/           # Shard metadata (JSON)
│   │   ├── default_edge.json
│   │   └── default_node.json
│   ├── batches/          # Data files (Parquet)
│   │   ├── 1.parquet
│   │   └── 2.parquet
│   └── wal/              # Write-ahead log
│       └── current.wal
</code></pre>
<hr/>
<h2 id="durability-modes" node="[object Object]">Durability Modes</h2>
<p>InputLayer offers three durability modes, configurable via <code class="bg-muted rounded px-1.5 py-0.5 font-mono text-sm" node="[object Object]">config.toml</code>:</p>
<h3 id="immediate-mode-default" node="[object Object]">Immediate Mode (Default)</h3>
<p>Every write syncs to disk before returning:</p>
<pre class="rounded-lg bg-[var(--code-bg)] p-4 overflow-x-auto mb-4 text-sm font-mono" node="[object Object]"><code class="language-toml text-sm"><span class="syn-meta">[storage.persist]</span>
<span class="syn-identifier">durability_mode</span> = <span class="syn-string">"immediate"</span></code></pre>
<div class="my-4 overflow-x-auto"><table class="w-full border-collapse" node="[object Object]"><thead><tr><th class="border px-4 py-2 text-left font-semibold bg-muted/50" node="[object Object]">Property</th><th class="border px-4 py-2 text-left font-semibold bg-muted/50" node="[object Object]">Value</th></tr></thead><tbody><tr><td class="border px-4 py-2" node="[object Object]">Write Latency</td><td class="border px-4 py-2" node="[object Object]">Highest</td></tr><tr><td class="border px-4 py-2" node="[object Object]">Crash Safety</td><td class="border px-4 py-2" node="[object Object]">Full (zero data loss)</td></tr><tr><td class="border px-4 py-2" node="[object Object]">Use Case</td><td class="border px-4 py-2" node="[object Object]">Financial data, critical records</td></tr></tbody></table></div>
<h3 id="batched-mode" node="[object Object]">Batched Mode</h3>
<p>Writes buffer in memory with periodic sync:</p>
<pre class="rounded-lg bg-[var(--code-bg)] p-4 overflow-x-auto mb-4 text-sm font-mono" node="[object Object]"><code class="language-toml text-sm"><span class="syn-meta">[storage.persist]</span>
<span class="syn-identifier">durability_mode</span> = <span class="syn-string">"batched"</span>
<span class="syn-identifier">buffer_size</span> = <span class="syn-number">10000</span></code></pre>
<div class="my-4 overflow-x-auto"><table class="w-full border-collapse" node="[object Object]"><thead><tr><th class="border px-4 py-2 text-left font-semibold bg-muted/50" node="[object Object]">Property</th><th class="border px-4 py-2 text-left font-semibold bg-muted/50" node="[object Object]">Value</th></tr></thead><tbody><tr><td class="border px-4 py-2" node="[object Object]">Write Latency</td><td class="border px-4 py-2" node="[object Object]">Medium</td></tr><tr><td class="border px-4 py-2" node="[object Object]">Crash Safety</td><td class="border px-4 py-2" node="[object Object]">Partial (may lose last batch)</td></tr><tr><td class="border px-4 py-2" node="[object Object]">Use Case</td><td class="border px-4 py-2" node="[object Object]">Most production workloads</td></tr></tbody></table></div>
<h3 id="async-mode" node="[object Object]">Async Mode</h3>
<p>Writes return immediately; background persistence:</p>
<pre class="rounded-lg bg-[var(--code-bg)] p-4 overflow-x-auto mb-4 text-sm font-mono" node="[object Object]"><code class="language-toml text-sm"><span class="syn-meta">[storage.persist]</span>
<span class="syn-identifier">durability_mode</span> = <span class="syn-string">"async"</span></code></pre>
<div class="my-4 overflow-x-auto"><table class="w-full border-collapse" node="[object Object]"><thead><tr><th class="border px-4 py-2 text-left font-semibold bg-muted/50" node="[object Object]">Property</th><th class="border px-4 py-2 text-left font-semibold bg-muted/50" node="[object Object]">Value</th></tr></thead><tbody><tr><td class="border px-4 py-2" node="[object Object]">Write Latency</td><td class="border px-4 py-2" node="[object Object]">Lowest</td></tr><tr><td class="border px-4 py-2" node="[object Object]">Crash Safety</td><td class="border px-4 py-2" node="[object Object]">Minimal (may lose recent updates)</td></tr><tr><td class="border px-4 py-2" node="[object Object]">Use Case</td><td class="border px-4 py-2" node="[object Object]">Analytics pipelines, high-throughput ingestion</td></tr></tbody></table></div>
<hr/>
<h2 id="write-ahead-log-wal" node="[object Object]">Write-Ahead Log (WAL)</h2>
<p>The WAL provides O(1) append-only persistence with immediate durability.</p>
<h3 id="wal-entry-format" node="[object Object]">WAL Entry Format</h3>
<p>Each entry is a checksummed JSON line (format: <code class="bg-muted rounded px-1.5 py-0.5 font-mono text-sm" node="[object Object]">&lt;crc32hex&gt;:&lt;json&gt;</code>):</p>
<pre class="rounded-lg bg-[var(--code-bg)] p-4 overflow-x-auto mb-4 text-sm font-mono" node="[object Object]"><code class="language-json text-sm">{<span class="syn-identifier">"shard"</span>:<span class="syn-string">"default:edge"</span>,<span class="syn-identifier">"update"</span>:{<span class="syn-identifier">"data"</span>:[<span class="syn-number">1</span>,<span class="syn-number">2</span>],<span class="syn-identifier">"time"</span>:<span class="syn-number">1</span>,<span class="syn-identifier">"diff"</span>:<span class="syn-number">1</span>}}
{<span class="syn-identifier">"shard"</span>:<span class="syn-string">"default:edge"</span>,<span class="syn-identifier">"update"</span>:{<span class="syn-identifier">"data"</span>:[<span class="syn-number">1</span>,<span class="syn-number">2</span>],<span class="syn-identifier">"time"</span>:<span class="syn-number">2</span>,<span class="syn-identifier">"diff"</span>:<span class="syn-number">-1</span>}}</code></pre>
<h3 id="wal-entry-fields" node="[object Object]">WAL Entry Fields</h3>
<div class="my-4 overflow-x-auto"><table class="w-full border-collapse" node="[object Object]"><thead><tr><th class="border px-4 py-2 text-left font-semibold bg-muted/50" node="[object Object]">Field</th><th class="border px-4 py-2 text-left font-semibold bg-muted/50" node="[object Object]">Description</th></tr></thead><tbody><tr><td class="border px-4 py-2" node="[object Object]"><code class="bg-muted rounded px-1.5 py-0.5 font-mono text-sm" node="[object Object]">shard</code></td><td class="border px-4 py-2" node="[object Object]">Shard name in <code class="bg-muted rounded px-1.5 py-0.5 font-mono text-sm" node="[object Object]">&quot;kg:relation&quot;</code> format</td></tr><tr><td class="border px-4 py-2" node="[object Object]"><code class="bg-muted rounded px-1.5 py-0.5 font-mono text-sm" node="[object Object]">update.data</code></td><td class="border px-4 py-2" node="[object Object]">The tuple data</td></tr><tr><td class="border px-4 py-2" node="[object Object]"><code class="bg-muted rounded px-1.5 py-0.5 font-mono text-sm" node="[object Object]">update.time</code></td><td class="border px-4 py-2" node="[object Object]">Logical timestamp (monotonically increasing)</td></tr><tr><td class="border px-4 py-2" node="[object Object]"><code class="bg-muted rounded px-1.5 py-0.5 font-mono text-sm" node="[object Object]">update.diff</code></td><td class="border px-4 py-2" node="[object Object]">Multiplicity change: <code class="bg-muted rounded px-1.5 py-0.5 font-mono text-sm" node="[object Object]">+1</code> for insert, <code class="bg-muted rounded px-1.5 py-0.5 font-mono text-sm" node="[object Object]">-1</code> for delete</td></tr></tbody></table></div>
<p>Each line is prefixed with a CRC32 checksum for integrity verification during recovery.</p>
<h3 id="automatic-compaction" node="[object Object]">Automatic Compaction</h3>
<p>WAL entries are compacted to Parquet when:</p>
<ul>
<li>Buffer reaches configured size (<code class="bg-muted rounded px-1.5 py-0.5 font-mono text-sm" node="[object Object]">buffer_size</code>)</li>
<li>Manual flush is triggered</li>
<li>Server shutdown (clean)</li>
</ul>
<p>After compaction, the WAL is archived and cleared.</p>
<hr/>
<h2 id="batch-files-parquet" node="[object Object]">Batch Files (Parquet)</h2>
<p>Data is stored in columnar Parquet format for efficient queries.</p>
<h3 id="parquet-schema" node="[object Object]">Parquet Schema</h3>
<p>Each batch file contains:</p>
<ul>
<li><strong>Data columns</strong>: Your tuple fields</li>
<li><strong>time</strong>: Update timestamp (UInt64)</li>
<li><strong>diff</strong>: +1 for insert, -1 for delete (Int64)</li>
</ul>
<h3 id="compression" node="[object Object]">Compression</h3>
<p>Snappy compression is used by default (fast decompression, good ratio).</p>
<h3 id="example-file" node="[object Object]">Example File</h3>
<pre class="rounded-lg bg-[var(--code-bg)] p-4 overflow-x-auto mb-4 text-sm font-mono" node="[object Object]"><code class="bg-muted rounded px-1.5 py-0.5 font-mono text-sm" node="[object Object]">batches/1.parquet
├── col0: Int32 [1, 3, 5]
├── col1: Int32 [2, 4, 6]
├── time: UInt64 [10, 20, 30]
└── diff: Int64 [1, 1, 1]
</code></pre>
<hr/>
<h2 id="shards" node="[object Object]">Shards</h2>
<p>Each relation is stored as a separate &quot;shard&quot; with its own:</p>
<ul>
<li>Metadata file (JSON)</li>
<li>Batch files (Parquet)</li>
<li>WAL entries</li>
</ul>
<h3 id="shard-metadata" node="[object Object]">Shard Metadata</h3>
<pre class="rounded-lg bg-[var(--code-bg)] p-4 overflow-x-auto mb-4 text-sm font-mono" node="[object Object]"><code class="language-json text-sm">{
  <span class="syn-identifier">"name"</span>: <span class="syn-string">"default:edge"</span>,
  <span class="syn-identifier">"since"</span>: <span class="syn-number">0</span>,
  <span class="syn-identifier">"upper"</span>: <span class="syn-number">100</span>,
  <span class="syn-identifier">"batches"</span>: [
    {
      <span class="syn-identifier">"id"</span>: <span class="syn-string">"1"</span>,
      <span class="syn-identifier">"path"</span>: <span class="syn-string">"batches/1.parquet"</span>,
      <span class="syn-identifier">"lower"</span>: <span class="syn-number">0</span>,
      <span class="syn-identifier">"upper"</span>: <span class="syn-number">50</span>,
      <span class="syn-identifier">"len"</span>: <span class="syn-number">100</span>
    }
  ]
}</code></pre>
<div class="my-4 overflow-x-auto"><table class="w-full border-collapse" node="[object Object]"><thead><tr><th class="border px-4 py-2 text-left font-semibold bg-muted/50" node="[object Object]">Field</th><th class="border px-4 py-2 text-left font-semibold bg-muted/50" node="[object Object]">Description</th></tr></thead><tbody><tr><td class="border px-4 py-2" node="[object Object]"><code class="bg-muted rounded px-1.5 py-0.5 font-mono text-sm" node="[object Object]">name</code></td><td class="border px-4 py-2" node="[object Object]">Shard identifier (kg:relation)</td></tr><tr><td class="border px-4 py-2" node="[object Object]"><code class="bg-muted rounded px-1.5 py-0.5 font-mono text-sm" node="[object Object]">since</code></td><td class="border px-4 py-2" node="[object Object]">Lower bound frontier (history discarded before this)</td></tr><tr><td class="border px-4 py-2" node="[object Object]"><code class="bg-muted rounded px-1.5 py-0.5 font-mono text-sm" node="[object Object]">upper</code></td><td class="border px-4 py-2" node="[object Object]">Upper bound frontier (latest update time + 1)</td></tr><tr><td class="border px-4 py-2" node="[object Object]"><code class="bg-muted rounded px-1.5 py-0.5 font-mono text-sm" node="[object Object]">batches</code></td><td class="border px-4 py-2" node="[object Object]">List of batch file references</td></tr></tbody></table></div>
<hr/>
<h2 id="compaction" node="[object Object]">Compaction</h2>
<p>Compaction consolidates history and reclaims space.</p>
<h3 id="manual-compaction" node="[object Object]">Manual Compaction</h3>
<pre class="rounded-lg bg-[var(--code-bg)] p-4 overflow-x-auto mb-4 text-sm font-mono" node="[object Object]"><code class="language-datalog text-sm"><span class="syn-meta">.compact</span>
</code></pre>
<p>This:</p>
<ol>
<li>Flushes all pending writes</li>
<li>Merges batch files</li>
<li>Removes historical entries before <code class="bg-muted rounded px-1.5 py-0.5 font-mono text-sm" node="[object Object]">since</code> frontier</li>
<li>Clears WAL</li>
</ol>
<h3 id="automatic-compaction" node="[object Object]">Automatic Compaction</h3>
<p>Compaction is triggered automatically when a shard accumulates more than <code class="bg-muted rounded px-1.5 py-0.5 font-mono text-sm" node="[object Object]">auto_compact_threshold</code> batch files (default: 10). The check runs every <code class="bg-muted rounded px-1.5 py-0.5 font-mono text-sm" node="[object Object]">auto_compact_interval_secs</code> seconds (default: 300).</p>
<pre class="rounded-lg bg-[var(--code-bg)] p-4 overflow-x-auto mb-4 text-sm font-mono" node="[object Object]"><code class="language-toml text-sm"><span class="syn-meta">[storage.persist]</span>
<span class="syn-identifier">auto_compact_threshold</span> = <span class="syn-number">10</span>      <span class="syn-comment"># Compact after this many batch files</span>
<span class="syn-identifier">auto_compact_interval_secs</span> = <span class="syn-number">300</span>  <span class="syn-comment"># Check interval (seconds)</span></code></pre>
<hr/>
<h2 id="configuration-reference" node="[object Object]">Configuration Reference</h2>
<pre class="rounded-lg bg-[var(--code-bg)] p-4 overflow-x-auto mb-4 text-sm font-mono" node="[object Object]"><code class="language-toml text-sm"><span class="syn-meta">[storage]</span>
<span class="syn-comment"># Base directory for all data</span>
<span class="syn-identifier">data_dir</span> = <span class="syn-string">"./data"</span>

<span class="syn-meta">[storage.persist]</span>
<span class="syn-comment"># Enable DD-native persistence</span>
<span class="syn-identifier">enabled</span> = <span class="syn-keyword">true</span>

<span class="syn-comment"># Buffer size before flushing to Parquet</span>
<span class="syn-identifier">buffer_size</span> = <span class="syn-number">10000</span>

<span class="syn-comment"># Durability: immediate, batched, async</span>
<span class="syn-identifier">durability_mode</span> = <span class="syn-string">"immediate"</span>

<span class="syn-comment"># Auto-compact when this many batch files accumulate (0 = disabled)</span>
<span class="syn-identifier">auto_compact_threshold</span> = <span class="syn-number">10</span>

<span class="syn-comment"># Check interval for auto-compaction in seconds (0 = disabled)</span>
<span class="syn-identifier">auto_compact_interval_secs</span> = <span class="syn-number">300</span></code></pre>
<hr/>
<h2 id="best-practices" node="[object Object]">Best Practices</h2>
<h3 id="development" node="[object Object]">Development</h3>
<pre class="rounded-lg bg-[var(--code-bg)] p-4 overflow-x-auto mb-4 text-sm font-mono" node="[object Object]"><code class="language-toml text-sm"><span class="syn-meta">[storage.persist]</span>
<span class="syn-identifier">durability_mode</span> = <span class="syn-string">"async"</span>
<span class="syn-identifier">buffer_size</span> = <span class="syn-number">1000</span></code></pre>
<p>Fast iteration, acceptable data loss on crashes.</p>
<h3 id="production" node="[object Object]">Production</h3>
<pre class="rounded-lg bg-[var(--code-bg)] p-4 overflow-x-auto mb-4 text-sm font-mono" node="[object Object]"><code class="language-toml text-sm"><span class="syn-meta">[storage.persist]</span>
<span class="syn-identifier">durability_mode</span> = <span class="syn-string">"immediate"</span>
<span class="syn-identifier">buffer_size</span> = <span class="syn-number">10000</span></code></pre>
<p>Maximum safety, reasonable performance.</p>
<h3 id="high-throughput-ingestion" node="[object Object]">High-Throughput Ingestion</h3>
<pre class="rounded-lg bg-[var(--code-bg)] p-4 overflow-x-auto mb-4 text-sm font-mono" node="[object Object]"><code class="language-toml text-sm"><span class="syn-meta">[storage.persist]</span>
<span class="syn-identifier">durability_mode</span> = <span class="syn-string">"batched"</span>
<span class="syn-identifier">buffer_size</span> = <span class="syn-number">100000</span>

<span class="syn-meta">[storage.performance]</span>
<span class="syn-identifier">batch_size</span> = <span class="syn-number">10000</span>
<span class="syn-identifier">async_io</span> = <span class="syn-keyword">true</span></code></pre>
<p>Balance between throughput and safety.</p>
<h3 id="memory-constrained" node="[object Object]">Memory-Constrained</h3>
<pre class="rounded-lg bg-[var(--code-bg)] p-4 overflow-x-auto mb-4 text-sm font-mono" node="[object Object]"><code class="language-toml text-sm"><span class="syn-meta">[storage.persist]</span>
<span class="syn-identifier">buffer_size</span> = <span class="syn-number">1000</span>
<span class="syn-identifier">auto_compact_threshold</span> = <span class="syn-number">5</span>

<span class="syn-meta">[storage.performance]</span>
<span class="syn-identifier">initial_capacity</span> = <span class="syn-number">1000</span>
<span class="syn-identifier">batch_size</span> = <span class="syn-number">100</span></code></pre>
<p>Frequent flushes, aggressive compaction.</p>
<hr/>
<h2 id="monitoring" node="[object Object]">Monitoring</h2>
<h3 id="check-storage-status" node="[object Object]">Check Storage Status</h3>
<pre class="rounded-lg bg-[var(--code-bg)] p-4 overflow-x-auto mb-4 text-sm font-mono" node="[object Object]"><code class="language-bash text-sm">.status</code></pre>
<p>Shows:</p>
<ul>
<li>Data directory location</li>
<li>Number of shards</li>
<li>WAL size</li>
<li>Buffer status</li>
</ul>
<h3 id="check-shard-info" node="[object Object]">Check Shard Info</h3>
<pre class="rounded-lg bg-[var(--code-bg)] p-4 overflow-x-auto mb-4 text-sm font-mono" node="[object Object]"><code class="language-datalog text-sm"><span class="syn-meta">.rel</span>
</code></pre>
<p>Lists all relations with row counts.</p>
<hr/>
<h2 id="recovery-scenarios" node="[object Object]">Recovery Scenarios</h2>
<h3 id="normal-startup" node="[object Object]">Normal Startup</h3>
<ol>
<li>Load shard metadata</li>
<li>Read Parquet batch files</li>
<li>Replay WAL entries</li>
<li>Consolidate to current state</li>
</ol>
<h3 id="crash-recovery" node="[object Object]">Crash Recovery</h3>
<p>Same as normal startup. WAL ensures all committed writes are recovered.</p>
<h3 id="corrupted-parquet" node="[object Object]">Corrupted Parquet</h3>
<p>If a batch file is corrupted:</p>
<ol>
<li>WAL entries for that batch may still be available</li>
<li>Manually remove corrupted <code class="bg-muted rounded px-1.5 py-0.5 font-mono text-sm" node="[object Object]">.parquet</code> file</li>
<li>Restart to trigger WAL replay</li>
</ol>
<h3 id="corrupted-wal" node="[object Object]">Corrupted WAL</h3>
<p>If WAL is corrupted:</p>
<ol>
<li>Data in Parquet files is safe</li>
<li>Uncommitted writes since last flush are lost</li>
<li>Rename/remove corrupted WAL file</li>
<li>Restart</li>
</ol>
<hr/>
<h2 id="differential-updates" node="[object Object]">Differential Updates</h2>
<p>InputLayer uses differential dataflow semantics internally:</p>
<pre class="rounded-lg bg-[var(--code-bg)] p-4 overflow-x-auto mb-4 text-sm font-mono" node="[object Object]"><code class="language-rust text-sm">Update {
    data: Tuple,    <span class="syn-comment">// The actual data</span>
    time: <span class="syn-keyword">u64</span>,      <span class="syn-comment">// Logical timestamp</span>
    diff: <span class="syn-keyword">i64</span>,      <span class="syn-comment">// +1 = insert, -1 = delete</span>
}</code></pre>
<h3 id="consolidation" node="[object Object]">Consolidation</h3>
<p>Multiple updates to the same tuple are consolidated:</p>
<div class="my-4 overflow-x-auto"><table class="w-full border-collapse" node="[object Object]"><thead><tr><th class="border px-4 py-2 text-left font-semibold bg-muted/50" node="[object Object]">Updates</th><th class="border px-4 py-2 text-left font-semibold bg-muted/50" node="[object Object]">Consolidated</th></tr></thead><tbody><tr><td class="border px-4 py-2" node="[object Object]">+1, +1</td><td class="border px-4 py-2" node="[object Object]">+2 (duplicate insert)</td></tr><tr><td class="border px-4 py-2" node="[object Object]">+1, -1</td><td class="border px-4 py-2" node="[object Object]">0 (cancelled out)</td></tr><tr><td class="border px-4 py-2" node="[object Object]">+1, -1, +1</td><td class="border px-4 py-2" node="[object Object]">+1 (net insert)</td></tr></tbody></table></div>
<p>This enables:</p>
<ul>
<li>Efficient delta storage</li>
<li>Time-travel queries (if history preserved)</li>
<li>Incremental computation</li>
</ul>
<hr/>
<h2 id="troubleshooting" node="[object Object]">Troubleshooting</h2>
<h3 id="high-write-latency" node="[object Object]">High Write Latency</h3>
<p><strong>Cause</strong>: Immediate durability mode with slow disk</p>
<p><strong>Solutions</strong>:</p>
<ol>
<li>Switch to <code class="bg-muted rounded px-1.5 py-0.5 font-mono text-sm" node="[object Object]">batched</code> durability mode</li>
<li>Use faster storage (SSD)</li>
<li>Increase <code class="bg-muted rounded px-1.5 py-0.5 font-mono text-sm" node="[object Object]">buffer_size</code> to batch more writes</li>
</ol>
<h3 id="high-memory-usage" node="[object Object]">High Memory Usage</h3>
<p><strong>Cause</strong>: Large buffer, many shards</p>
<p><strong>Solutions</strong>:</p>
<ol>
<li>Reduce <code class="bg-muted rounded px-1.5 py-0.5 font-mono text-sm" node="[object Object]">buffer_size</code></li>
<li>Lower <code class="bg-muted rounded px-1.5 py-0.5 font-mono text-sm" node="[object Object]">auto_compact_threshold</code> for more frequent compaction</li>
<li>Flush more frequently</li>
</ol>
<h3 id="slow-startup" node="[object Object]">Slow Startup</h3>
<p><strong>Cause</strong>: Large WAL, many batch files</p>
<p><strong>Solutions</strong>:</p>
<ol>
<li>Run <code class="bg-muted rounded px-1.5 py-0.5 font-mono text-sm" node="[object Object]">.compact</code> before shutdown</li>
<li>Enable compaction window</li>
<li>Flush buffers before shutdown</li>
</ol>
<h3 id="missing-data-after-crash" node="[object Object]">Missing Data After Crash</h3>
<p><strong>Cause</strong>: Async durability mode</p>
<p><strong>Solutions</strong>:</p>
<ol>
<li>Switch to <code class="bg-muted rounded px-1.5 py-0.5 font-mono text-sm" node="[object Object]">immediate</code> or <code class="bg-muted rounded px-1.5 py-0.5 font-mono text-sm" node="[object Object]">batched</code> mode</li>
<li>Accept trade-off for async mode</li>
</ol>
<hr/>
<h2 id="next-steps" node="[object Object]">Next Steps</h2>
<ul>
<li><a href="configuration" target="_blank" rel="noopener noreferrer" node="[object Object]">Configuration Guide</a> - Full configuration reference</li>
<li><a href="rest-api" target="_blank" rel="noopener noreferrer" node="[object Object]">REST API Guide</a> - Programmatic access</li>
<li><a href="temporal" target="_blank" rel="noopener noreferrer" node="[object Object]">Temporal Functions</a> - Time-based queries on persisted data</li>
</ul></article></div><div class="hidden lg:block w-48 shrink-0 border-l border-border/50"><div class="sticky top-0 p-4"><p class="text-xs font-semibold text-muted-foreground uppercase tracking-wider mb-3">On this page</p><nav class="space-y-1"><a href="#architecture-overview" class="block text-xs py-0.5 transition-colors hover:text-foreground text-muted-foreground">Architecture Overview</a><a href="#recovery-flow" class="block text-xs py-0.5 transition-colors hover:text-foreground pl-3 text-muted-foreground">Recovery Flow</a><a href="#directory-structure" class="block text-xs py-0.5 transition-colors hover:text-foreground text-muted-foreground">Directory Structure</a><a href="#durability-modes" class="block text-xs py-0.5 transition-colors hover:text-foreground text-muted-foreground">Durability Modes</a><a href="#immediate-mode-default" class="block text-xs py-0.5 transition-colors hover:text-foreground pl-3 text-muted-foreground">Immediate Mode (Default)</a><a href="#batched-mode" class="block text-xs py-0.5 transition-colors hover:text-foreground pl-3 text-muted-foreground">Batched Mode</a><a href="#async-mode" class="block text-xs py-0.5 transition-colors hover:text-foreground pl-3 text-muted-foreground">Async Mode</a><a href="#write-ahead-log-wal" class="block text-xs py-0.5 transition-colors hover:text-foreground text-muted-foreground">Write-Ahead Log (WAL)</a><a href="#wal-entry-format" class="block text-xs py-0.5 transition-colors hover:text-foreground pl-3 text-muted-foreground">WAL Entry Format</a><a href="#wal-entry-fields" class="block text-xs py-0.5 transition-colors hover:text-foreground pl-3 text-muted-foreground">WAL Entry Fields</a><a href="#automatic-compaction" class="block text-xs py-0.5 transition-colors hover:text-foreground pl-3 text-muted-foreground">Automatic Compaction</a><a href="#batch-files-parquet" class="block text-xs py-0.5 transition-colors hover:text-foreground text-muted-foreground">Batch Files (Parquet)</a><a href="#parquet-schema" class="block text-xs py-0.5 transition-colors hover:text-foreground pl-3 text-muted-foreground">Parquet Schema</a><a href="#compression" class="block text-xs py-0.5 transition-colors hover:text-foreground pl-3 text-muted-foreground">Compression</a><a href="#example-file" class="block text-xs py-0.5 transition-colors hover:text-foreground pl-3 text-muted-foreground">Example File</a><a href="#shards" class="block text-xs py-0.5 transition-colors hover:text-foreground text-muted-foreground">Shards</a><a href="#shard-metadata" class="block text-xs py-0.5 transition-colors hover:text-foreground pl-3 text-muted-foreground">Shard Metadata</a><a href="#compaction" class="block text-xs py-0.5 transition-colors hover:text-foreground text-muted-foreground">Compaction</a><a href="#manual-compaction" class="block text-xs py-0.5 transition-colors hover:text-foreground pl-3 text-muted-foreground">Manual Compaction</a><a href="#automatic-compaction" class="block text-xs py-0.5 transition-colors hover:text-foreground pl-3 text-muted-foreground">Automatic Compaction</a><a href="#configuration-reference" class="block text-xs py-0.5 transition-colors hover:text-foreground text-muted-foreground">Configuration Reference</a><a href="#best-practices" class="block text-xs py-0.5 transition-colors hover:text-foreground text-muted-foreground">Best Practices</a><a href="#development" class="block text-xs py-0.5 transition-colors hover:text-foreground pl-3 text-muted-foreground">Development</a><a href="#production" class="block text-xs py-0.5 transition-colors hover:text-foreground pl-3 text-muted-foreground">Production</a><a href="#high-throughput-ingestion" class="block text-xs py-0.5 transition-colors hover:text-foreground pl-3 text-muted-foreground">High-Throughput Ingestion</a><a href="#memory-constrained" class="block text-xs py-0.5 transition-colors hover:text-foreground pl-3 text-muted-foreground">Memory-Constrained</a><a href="#monitoring" class="block text-xs py-0.5 transition-colors hover:text-foreground text-muted-foreground">Monitoring</a><a href="#check-storage-status" class="block text-xs py-0.5 transition-colors hover:text-foreground pl-3 text-muted-foreground">Check Storage Status</a><a href="#check-shard-info" class="block text-xs py-0.5 transition-colors hover:text-foreground pl-3 text-muted-foreground">Check Shard Info</a><a href="#recovery-scenarios" class="block text-xs py-0.5 transition-colors hover:text-foreground text-muted-foreground">Recovery Scenarios</a><a href="#normal-startup" class="block text-xs py-0.5 transition-colors hover:text-foreground pl-3 text-muted-foreground">Normal Startup</a><a href="#crash-recovery" class="block text-xs py-0.5 transition-colors hover:text-foreground pl-3 text-muted-foreground">Crash Recovery</a><a href="#corrupted-parquet" class="block text-xs py-0.5 transition-colors hover:text-foreground pl-3 text-muted-foreground">Corrupted Parquet</a><a href="#corrupted-wal" class="block text-xs py-0.5 transition-colors hover:text-foreground pl-3 text-muted-foreground">Corrupted WAL</a><a href="#differential-updates" class="block text-xs py-0.5 transition-colors hover:text-foreground text-muted-foreground">Differential Updates</a><a href="#consolidation" class="block text-xs py-0.5 transition-colors hover:text-foreground pl-3 text-muted-foreground">Consolidation</a><a href="#troubleshooting" class="block text-xs py-0.5 transition-colors hover:text-foreground text-muted-foreground">Troubleshooting</a><a href="#high-write-latency" class="block text-xs py-0.5 transition-colors hover:text-foreground pl-3 text-muted-foreground">High Write Latency</a><a href="#high-memory-usage" class="block text-xs py-0.5 transition-colors hover:text-foreground pl-3 text-muted-foreground">High Memory Usage</a><a href="#slow-startup" class="block text-xs py-0.5 transition-colors hover:text-foreground pl-3 text-muted-foreground">Slow Startup</a><a href="#missing-data-after-crash" class="block text-xs py-0.5 transition-colors hover:text-foreground pl-3 text-muted-foreground">Missing Data After Crash</a><a href="#next-steps" class="block text-xs py-0.5 transition-colors hover:text-foreground text-muted-foreground">Next Steps</a></nav></div></div></div></div></div></div><!--$--><!--/$--><script src="/_next/static/chunks/webpack-bd6546b43ab2ecbf.js" id="_R_" async=""></script><script>(self.__next_f=self.__next_f||[]).push([0])</script><script>self.__next_f.push([1,"1:\"$Sreact.fragment\"\n2:I[1942,[\"177\",\"static/chunks/app/layout-7e9963bf811be36b.js\"],\"ThemeProvider\"]\n3:I[7121,[],\"\"]\n4:I[4581,[],\"\"]\n6:I[484,[],\"OutletBoundary\"]\n7:\"$Sreact.suspense\"\n9:I[484,[],\"ViewportBoundary\"]\nb:I[484,[],\"MetadataBoundary\"]\nd:I[7123,[],\"\"]\n:HL[\"/_next/static/media/4cf2300e9c8272f7-s.p.woff2\",\"font\",{\"crossOrigin\":\"\",\"type\":\"font/woff2\"}]\n:HL[\"/_next/static/media/93f479601ee12b01-s.p.woff2\",\"font\",{\"crossOrigin\":\"\",\"type\":\"font/woff2\"}]\n:HL[\"/_next/static/css/4bd7a24b7976d4e6.css\",\"style\"]\n"])</script><script>self.__next_f.push([1,"0:{\"P\":null,\"b\":\"05bjYGyiAumoEMBrfWHih\",\"c\":[\"\",\"docs\",\"guides\",\"persistence\",\"\"],\"q\":\"\",\"i\":false,\"f\":[[[\"\",{\"children\":[\"docs\",{\"children\":[[\"slug\",\"guides/persistence\",\"oc\"],{\"children\":[\"__PAGE__\",{}]}]}]},\"$undefined\",\"$undefined\",true],[[\"$\",\"$1\",\"c\",{\"children\":[[[\"$\",\"link\",\"0\",{\"rel\":\"stylesheet\",\"href\":\"/_next/static/css/4bd7a24b7976d4e6.css\",\"precedence\":\"next\",\"crossOrigin\":\"$undefined\",\"nonce\":\"$undefined\"}]],[\"$\",\"html\",null,{\"lang\":\"en\",\"suppressHydrationWarning\":true,\"children\":[\"$\",\"body\",null,{\"className\":\"__variable_188709 __variable_9a8899 font-sans antialiased\",\"children\":[\"$\",\"$L2\",null,{\"attribute\":\"class\",\"defaultTheme\":\"dark\",\"enableSystem\":true,\"disableTransitionOnChange\":true,\"children\":[\"$\",\"$L3\",null,{\"parallelRouterKey\":\"children\",\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"errorScripts\":\"$undefined\",\"template\":[\"$\",\"$L4\",null,{}],\"templateStyles\":\"$undefined\",\"templateScripts\":\"$undefined\",\"notFound\":[[[\"$\",\"title\",null,{\"children\":\"404: This page could not be found.\"}],[\"$\",\"div\",null,{\"style\":{\"fontFamily\":\"system-ui,\\\"Segoe UI\\\",Roboto,Helvetica,Arial,sans-serif,\\\"Apple Color Emoji\\\",\\\"Segoe UI Emoji\\\"\",\"height\":\"100vh\",\"textAlign\":\"center\",\"display\":\"flex\",\"flexDirection\":\"column\",\"alignItems\":\"center\",\"justifyContent\":\"center\"},\"children\":[\"$\",\"div\",null,{\"children\":[[\"$\",\"style\",null,{\"dangerouslySetInnerHTML\":{\"__html\":\"body{color:#000;background:#fff;margin:0}.next-error-h1{border-right:1px solid rgba(0,0,0,.3)}@media (prefers-color-scheme:dark){body{color:#fff;background:#000}.next-error-h1{border-right:1px solid rgba(255,255,255,.3)}}\"}}],[\"$\",\"h1\",null,{\"className\":\"next-error-h1\",\"style\":{\"display\":\"inline-block\",\"margin\":\"0 20px 0 0\",\"padding\":\"0 23px 0 0\",\"fontSize\":24,\"fontWeight\":500,\"verticalAlign\":\"top\",\"lineHeight\":\"49px\"},\"children\":404}],[\"$\",\"div\",null,{\"style\":{\"display\":\"inline-block\"},\"children\":[\"$\",\"h2\",null,{\"style\":{\"fontSize\":14,\"fontWeight\":400,\"lineHeight\":\"49px\",\"margin\":0},\"children\":\"This page could not be found.\"}]}]]}]}]],[]],\"forbidden\":\"$undefined\",\"unauthorized\":\"$undefined\"}]}]}]}]]}],{\"children\":[[\"$\",\"$1\",\"c\",{\"children\":[null,[\"$\",\"$L3\",null,{\"parallelRouterKey\":\"children\",\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"errorScripts\":\"$undefined\",\"template\":[\"$\",\"$L4\",null,{}],\"templateStyles\":\"$undefined\",\"templateScripts\":\"$undefined\",\"notFound\":\"$undefined\",\"forbidden\":\"$undefined\",\"unauthorized\":\"$undefined\"}]]}],{\"children\":[[\"$\",\"$1\",\"c\",{\"children\":[null,[\"$\",\"$L3\",null,{\"parallelRouterKey\":\"children\",\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"errorScripts\":\"$undefined\",\"template\":[\"$\",\"$L4\",null,{}],\"templateStyles\":\"$undefined\",\"templateScripts\":\"$undefined\",\"notFound\":\"$undefined\",\"forbidden\":\"$undefined\",\"unauthorized\":\"$undefined\"}]]}],{\"children\":[[\"$\",\"$1\",\"c\",{\"children\":[\"$L5\",null,[\"$\",\"$L6\",null,{\"children\":[\"$\",\"$7\",null,{\"name\":\"Next.MetadataOutlet\",\"children\":\"$@8\"}]}]]}],{},null,false,false]},null,false,false]},null,false,false]},null,false,false],[\"$\",\"$1\",\"h\",{\"children\":[null,[\"$\",\"$L9\",null,{\"children\":\"$@a\"}],[\"$\",\"div\",null,{\"hidden\":true,\"children\":[\"$\",\"$Lb\",null,{\"children\":[\"$\",\"$7\",null,{\"name\":\"Next.Metadata\",\"children\":\"$@c\"}]}]}],[\"$\",\"meta\",null,{\"name\":\"next-size-adjust\",\"content\":\"\"}]]}],false]],\"m\":\"$undefined\",\"G\":[\"$d\",[]],\"S\":true}\n"])</script><script>self.__next_f.push([1,"e:I[8428,[\"758\",\"static/chunks/758-3cb69ce377cde046.js\",\"121\",\"static/chunks/121-aece4f809b101dc1.js\",\"502\",\"static/chunks/502-e809071f8789437b.js\",\"689\",\"static/chunks/689-4fcf9680fdc90283.js\",\"870\",\"static/chunks/app/docs/%5B%5B...slug%5D%5D/page-004ec69e3c86920a.js\"],\"DocsPageClient\"]\nf:T2064,"])</script><script>self.__next_f.push([1,"# Persistence Guide\n\nInputLayer provides durable storage with crash recovery, using a combination of Write-Ahead Logging (WAL) and Parquet batch files.\n\n## Architecture Overview\n\n```\nInsert/Delete\n    ↓\nUpdate{data, time, diff}\n    ↓\nWAL (immediate durability)\n    ↓\nIn-memory buffer\n    ↓ (when buffer full)\nBatch file (Parquet)\n```\n\n### Recovery Flow\n\nOn startup, InputLayer:\n1. Loads shard metadata from disk\n2. Reads batch files (Parquet)\n3. Replays WAL (uncommitted updates)\n4. Consolidates to get current state\n\n---\n\n## Directory Structure\n\n```\ndata/\n├── persist/\n│   ├── shards/           # Shard metadata (JSON)\n│   │   ├── default_edge.json\n│   │   └── default_node.json\n│   ├── batches/          # Data files (Parquet)\n│   │   ├── 1.parquet\n│   │   └── 2.parquet\n│   └── wal/              # Write-ahead log\n│       └── current.wal\n```\n\n---\n\n## Durability Modes\n\nInputLayer offers three durability modes, configurable via `config.toml`:\n\n### Immediate Mode (Default)\n\nEvery write syncs to disk before returning:\n\n```toml\n[storage.persist]\ndurability_mode = \"immediate\"\n```\n\n| Property | Value |\n|----------|-------|\n| Write Latency | Highest |\n| Crash Safety | Full (zero data loss) |\n| Use Case | Financial data, critical records |\n\n### Batched Mode\n\nWrites buffer in memory with periodic sync:\n\n```toml\n[storage.persist]\ndurability_mode = \"batched\"\nbuffer_size = 10000\n```\n\n| Property | Value |\n|----------|-------|\n| Write Latency | Medium |\n| Crash Safety | Partial (may lose last batch) |\n| Use Case | Most production workloads |\n\n### Async Mode\n\nWrites return immediately; background persistence:\n\n```toml\n[storage.persist]\ndurability_mode = \"async\"\n```\n\n| Property | Value |\n|----------|-------|\n| Write Latency | Lowest |\n| Crash Safety | Minimal (may lose recent updates) |\n| Use Case | Analytics pipelines, high-throughput ingestion |\n\n---\n\n## Write-Ahead Log (WAL)\n\nThe WAL provides O(1) append-only persistence with immediate durability.\n\n### WAL Entry Format\n\nEach entry is a checksummed JSON line (format: `\u003ccrc32hex\u003e:\u003cjson\u003e`):\n\n```json\n{\"shard\":\"default:edge\",\"update\":{\"data\":[1,2],\"time\":1,\"diff\":1}}\n{\"shard\":\"default:edge\",\"update\":{\"data\":[1,2],\"time\":2,\"diff\":-1}}\n```\n\n### WAL Entry Fields\n\n| Field | Description |\n|-------|-------------|\n| `shard` | Shard name in `\"kg:relation\"` format |\n| `update.data` | The tuple data |\n| `update.time` | Logical timestamp (monotonically increasing) |\n| `update.diff` | Multiplicity change: `+1` for insert, `-1` for delete |\n\nEach line is prefixed with a CRC32 checksum for integrity verification during recovery.\n\n### Automatic Compaction\n\nWAL entries are compacted to Parquet when:\n- Buffer reaches configured size (`buffer_size`)\n- Manual flush is triggered\n- Server shutdown (clean)\n\nAfter compaction, the WAL is archived and cleared.\n\n---\n\n## Batch Files (Parquet)\n\nData is stored in columnar Parquet format for efficient queries.\n\n### Parquet Schema\n\nEach batch file contains:\n- **Data columns**: Your tuple fields\n- **time**: Update timestamp (UInt64)\n- **diff**: +1 for insert, -1 for delete (Int64)\n\n### Compression\n\nSnappy compression is used by default (fast decompression, good ratio).\n\n### Example File\n\n```\nbatches/1.parquet\n├── col0: Int32 [1, 3, 5]\n├── col1: Int32 [2, 4, 6]\n├── time: UInt64 [10, 20, 30]\n└── diff: Int64 [1, 1, 1]\n```\n\n---\n\n## Shards\n\nEach relation is stored as a separate \"shard\" with its own:\n- Metadata file (JSON)\n- Batch files (Parquet)\n- WAL entries\n\n### Shard Metadata\n\n```json\n{\n  \"name\": \"default:edge\",\n  \"since\": 0,\n  \"upper\": 100,\n  \"batches\": [\n    {\n      \"id\": \"1\",\n      \"path\": \"batches/1.parquet\",\n      \"lower\": 0,\n      \"upper\": 50,\n      \"len\": 100\n    }\n  ]\n}\n```\n\n| Field | Description |\n|-------|-------------|\n| `name` | Shard identifier (kg:relation) |\n| `since` | Lower bound frontier (history discarded before this) |\n| `upper` | Upper bound frontier (latest update time + 1) |\n| `batches` | List of batch file references |\n\n---\n\n## Compaction\n\nCompaction consolidates history and reclaims space.\n\n### Manual Compaction\n\n```datalog\n.compact\n```\n\nThis:\n1. Flushes all pending writes\n2. Merges batch files\n3. Removes historical entries before `since` frontier\n4. Clears WAL\n\n### Automatic Compaction\n\nCompaction is triggered automatically when a shard accumulates more than `auto_compact_threshold` batch files (default: 10). The check runs every `auto_compact_interval_secs` seconds (default: 300).\n\n```toml\n[storage.persist]\nauto_compact_threshold = 10      # Compact after this many batch files\nauto_compact_interval_secs = 300  # Check interval (seconds)\n```\n\n---\n\n## Configuration Reference\n\n```toml\n[storage]\n# Base directory for all data\ndata_dir = \"./data\"\n\n[storage.persist]\n# Enable DD-native persistence\nenabled = true\n\n# Buffer size before flushing to Parquet\nbuffer_size = 10000\n\n# Durability: immediate, batched, async\ndurability_mode = \"immediate\"\n\n# Auto-compact when this many batch files accumulate (0 = disabled)\nauto_compact_threshold = 10\n\n# Check interval for auto-compaction in seconds (0 = disabled)\nauto_compact_interval_secs = 300\n```\n\n---\n\n## Best Practices\n\n### Development\n\n```toml\n[storage.persist]\ndurability_mode = \"async\"\nbuffer_size = 1000\n```\n\nFast iteration, acceptable data loss on crashes.\n\n### Production\n\n```toml\n[storage.persist]\ndurability_mode = \"immediate\"\nbuffer_size = 10000\n```\n\nMaximum safety, reasonable performance.\n\n### High-Throughput Ingestion\n\n```toml\n[storage.persist]\ndurability_mode = \"batched\"\nbuffer_size = 100000\n\n[storage.performance]\nbatch_size = 10000\nasync_io = true\n```\n\nBalance between throughput and safety.\n\n### Memory-Constrained\n\n```toml\n[storage.persist]\nbuffer_size = 1000\nauto_compact_threshold = 5\n\n[storage.performance]\ninitial_capacity = 1000\nbatch_size = 100\n```\n\nFrequent flushes, aggressive compaction.\n\n---\n\n## Monitoring\n\n### Check Storage Status\n\n```bash\n.status\n```\n\nShows:\n- Data directory location\n- Number of shards\n- WAL size\n- Buffer status\n\n### Check Shard Info\n\n```datalog\n.rel\n```\n\nLists all relations with row counts.\n\n---\n\n## Recovery Scenarios\n\n### Normal Startup\n\n1. Load shard metadata\n2. Read Parquet batch files\n3. Replay WAL entries\n4. Consolidate to current state\n\n### Crash Recovery\n\nSame as normal startup. WAL ensures all committed writes are recovered.\n\n### Corrupted Parquet\n\nIf a batch file is corrupted:\n1. WAL entries for that batch may still be available\n2. Manually remove corrupted `.parquet` file\n3. Restart to trigger WAL replay\n\n### Corrupted WAL\n\nIf WAL is corrupted:\n1. Data in Parquet files is safe\n2. Uncommitted writes since last flush are lost\n3. Rename/remove corrupted WAL file\n4. Restart\n\n---\n\n## Differential Updates\n\nInputLayer uses differential dataflow semantics internally:\n\n```rust\nUpdate {\n    data: Tuple,    // The actual data\n    time: u64,      // Logical timestamp\n    diff: i64,      // +1 = insert, -1 = delete\n}\n```\n\n### Consolidation\n\nMultiple updates to the same tuple are consolidated:\n\n| Updates | Consolidated |\n|---------|-------------|\n| +1, +1 | +2 (duplicate insert) |\n| +1, -1 | 0 (cancelled out) |\n| +1, -1, +1 | +1 (net insert) |\n\nThis enables:\n- Efficient delta storage\n- Time-travel queries (if history preserved)\n- Incremental computation\n\n---\n\n## Troubleshooting\n\n### High Write Latency\n\n**Cause**: Immediate durability mode with slow disk\n\n**Solutions**:\n1. Switch to `batched` durability mode\n2. Use faster storage (SSD)\n3. Increase `buffer_size` to batch more writes\n\n### High Memory Usage\n\n**Cause**: Large buffer, many shards\n\n**Solutions**:\n1. Reduce `buffer_size`\n2. Lower `auto_compact_threshold` for more frequent compaction\n3. Flush more frequently\n\n### Slow Startup\n\n**Cause**: Large WAL, many batch files\n\n**Solutions**:\n1. Run `.compact` before shutdown\n2. Enable compaction window\n3. Flush buffers before shutdown\n\n### Missing Data After Crash\n\n**Cause**: Async durability mode\n\n**Solutions**:\n1. Switch to `immediate` or `batched` mode\n2. Accept trade-off for async mode\n\n---\n\n## Next Steps\n\n- [Configuration Guide](configuration) - Full configuration reference\n- [REST API Guide](rest-api) - Programmatic access\n- [Temporal Functions](temporal) - Time-based queries on persisted data"])</script><script>self.__next_f.push([1,"5:[\"$\",\"$Le\",null,{\"page\":{\"title\":\"Persistence Guide\",\"content\":\"$f\",\"toc\":[{\"level\":2,\"text\":\"Architecture Overview\",\"id\":\"architecture-overview\"},{\"level\":3,\"text\":\"Recovery Flow\",\"id\":\"recovery-flow\"},{\"level\":2,\"text\":\"Directory Structure\",\"id\":\"directory-structure\"},{\"level\":2,\"text\":\"Durability Modes\",\"id\":\"durability-modes\"},{\"level\":3,\"text\":\"Immediate Mode (Default)\",\"id\":\"immediate-mode-default\"},{\"level\":3,\"text\":\"Batched Mode\",\"id\":\"batched-mode\"},{\"level\":3,\"text\":\"Async Mode\",\"id\":\"async-mode\"},{\"level\":2,\"text\":\"Write-Ahead Log (WAL)\",\"id\":\"write-ahead-log-wal\"},{\"level\":3,\"text\":\"WAL Entry Format\",\"id\":\"wal-entry-format\"},{\"level\":3,\"text\":\"WAL Entry Fields\",\"id\":\"wal-entry-fields\"},{\"level\":3,\"text\":\"Automatic Compaction\",\"id\":\"automatic-compaction\"},{\"level\":2,\"text\":\"Batch Files (Parquet)\",\"id\":\"batch-files-parquet\"},{\"level\":3,\"text\":\"Parquet Schema\",\"id\":\"parquet-schema\"},{\"level\":3,\"text\":\"Compression\",\"id\":\"compression\"},{\"level\":3,\"text\":\"Example File\",\"id\":\"example-file\"},{\"level\":2,\"text\":\"Shards\",\"id\":\"shards\"},{\"level\":3,\"text\":\"Shard Metadata\",\"id\":\"shard-metadata\"},{\"level\":2,\"text\":\"Compaction\",\"id\":\"compaction\"},{\"level\":3,\"text\":\"Manual Compaction\",\"id\":\"manual-compaction\"},{\"level\":3,\"text\":\"Automatic Compaction\",\"id\":\"automatic-compaction\"},{\"level\":2,\"text\":\"Configuration Reference\",\"id\":\"configuration-reference\"},{\"level\":2,\"text\":\"Best Practices\",\"id\":\"best-practices\"},{\"level\":3,\"text\":\"Development\",\"id\":\"development\"},{\"level\":3,\"text\":\"Production\",\"id\":\"production\"},{\"level\":3,\"text\":\"High-Throughput Ingestion\",\"id\":\"high-throughput-ingestion\"},{\"level\":3,\"text\":\"Memory-Constrained\",\"id\":\"memory-constrained\"},{\"level\":2,\"text\":\"Monitoring\",\"id\":\"monitoring\"},{\"level\":3,\"text\":\"Check Storage Status\",\"id\":\"check-storage-status\"},{\"level\":3,\"text\":\"Check Shard Info\",\"id\":\"check-shard-info\"},{\"level\":2,\"text\":\"Recovery Scenarios\",\"id\":\"recovery-scenarios\"},{\"level\":3,\"text\":\"Normal Startup\",\"id\":\"normal-startup\"},{\"level\":3,\"text\":\"Crash Recovery\",\"id\":\"crash-recovery\"},{\"level\":3,\"text\":\"Corrupted Parquet\",\"id\":\"corrupted-parquet\"},{\"level\":3,\"text\":\"Corrupted WAL\",\"id\":\"corrupted-wal\"},{\"level\":2,\"text\":\"Differential Updates\",\"id\":\"differential-updates\"},{\"level\":3,\"text\":\"Consolidation\",\"id\":\"consolidation\"},{\"level\":2,\"text\":\"Troubleshooting\",\"id\":\"troubleshooting\"},{\"level\":3,\"text\":\"High Write Latency\",\"id\":\"high-write-latency\"},{\"level\":3,\"text\":\"High Memory Usage\",\"id\":\"high-memory-usage\"},{\"level\":3,\"text\":\"Slow Startup\",\"id\":\"slow-startup\"},{\"level\":3,\"text\":\"Missing Data After Crash\",\"id\":\"missing-data-after-crash\"},{\"level\":2,\"text\":\"Next Steps\",\"id\":\"next-steps\"}]},\"slugKey\":\"guides/persistence\"}]\n"])</script><script>self.__next_f.push([1,"a:[[\"$\",\"meta\",\"0\",{\"charSet\":\"utf-8\"}],[\"$\",\"meta\",\"1\",{\"name\":\"viewport\",\"content\":\"width=device-width, initial-scale=1\"}]]\n"])</script><script>self.__next_f.push([1,"10:I[6869,[],\"IconMark\"]\nc:[[\"$\",\"title\",\"0\",{\"children\":\"InputLayer - A symbolic reasoning engine for AI agents\"}],[\"$\",\"meta\",\"1\",{\"name\":\"description\",\"content\":\"Store facts, define rules, and derive everything that logically follows. Vector search, graph traversal, and incremental computation in one system.\"}],[\"$\",\"link\",\"2\",{\"rel\":\"icon\",\"href\":\"/icon.svg\"}],[\"$\",\"$L10\",\"3\",{}]]\n8:null\n"])</script></body></html>