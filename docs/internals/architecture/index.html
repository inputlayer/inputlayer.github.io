<!DOCTYPE html><!--05bjYGyiAumoEMBrfWHih--><html lang="en"><head><meta charSet="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/><link rel="preload" href="/_next/static/media/4cf2300e9c8272f7-s.p.woff2" as="font" crossorigin="" type="font/woff2"/><link rel="preload" href="/_next/static/media/93f479601ee12b01-s.p.woff2" as="font" crossorigin="" type="font/woff2"/><link rel="stylesheet" href="/_next/static/css/4bd7a24b7976d4e6.css" data-precedence="next"/><link rel="preload" as="script" fetchPriority="low" href="/_next/static/chunks/webpack-bd6546b43ab2ecbf.js"/><script src="/_next/static/chunks/4bd1b696-deba172d32c79f82.js" async=""></script><script src="/_next/static/chunks/794-275dc9ebd3a29fbf.js" async=""></script><script src="/_next/static/chunks/main-app-1fa5b694e5d36a75.js" async=""></script><script src="/_next/static/chunks/app/layout-7e9963bf811be36b.js" async=""></script><script src="/_next/static/chunks/758-3cb69ce377cde046.js" async=""></script><script src="/_next/static/chunks/121-aece4f809b101dc1.js" async=""></script><script src="/_next/static/chunks/502-e809071f8789437b.js" async=""></script><script src="/_next/static/chunks/689-4fcf9680fdc90283.js" async=""></script><script src="/_next/static/chunks/app/docs/%5B%5B...slug%5D%5D/page-004ec69e3c86920a.js" async=""></script><meta name="next-size-adjust" content=""/><title>InputLayer - A symbolic reasoning engine for AI agents</title><meta name="description" content="Store facts, define rules, and derive everything that logically follows. Vector search, graph traversal, and incremental computation in one system."/><link rel="icon" href="/icon.svg"/><script src="/_next/static/chunks/polyfills-42372ed130431b0a.js" noModule=""></script></head><body class="__variable_188709 __variable_9a8899 font-sans antialiased"><div hidden=""><!--$--><!--/$--></div><script>((a,b,c,d,e,f,g,h)=>{let i=document.documentElement,j=["light","dark"];function k(b){var c;(Array.isArray(a)?a:[a]).forEach(a=>{let c="class"===a,d=c&&f?e.map(a=>f[a]||a):e;c?(i.classList.remove(...d),i.classList.add(f&&f[b]?f[b]:b)):i.setAttribute(a,b)}),c=b,h&&j.includes(c)&&(i.style.colorScheme=c)}if(d)k(d);else try{let a=localStorage.getItem(b)||c,d=g&&"system"===a?window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light":a;k(d)}catch(a){}})("class","theme","dark",null,["light","dark"],null,true,true)</script><div class="flex flex-col h-dvh"><header class="sticky top-0 z-50 w-full border-b border-border/50 bg-background/95 backdrop-blur supports-[backdrop-filter]:bg-background/60"><div class="flex h-14 items-center px-6"><a class="mr-8" href="/"><span class="inline-flex items-center gap-1.5"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="flex-shrink-0"><path d="M12 2L2 7l10 5 10-5-10-5z"></path><path d="M2 17l10 5 10-5"></path><path d="M2 12l10 5 10-5"></path></svg><span class="font-extrabold tracking-tight text-lg">InputLayer</span></span></a><nav class="hidden md:flex items-center gap-6 text-sm"><a class="text-muted-foreground transition-colors hover:text-foreground" href="/docs/">Docs</a><a class="text-muted-foreground transition-colors hover:text-foreground" href="/blog/">Blog</a><a class="text-muted-foreground transition-colors hover:text-foreground" href="/use-cases/">Use Cases</a><a class="text-muted-foreground transition-colors hover:text-foreground" href="/compare/">Compare</a><a href="https://demo.inputlayer.ai" target="_blank" rel="noopener noreferrer" class="inline-flex items-center gap-1 text-muted-foreground transition-colors hover:text-foreground">Demo<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-external-link h-3 w-3"><path d="M15 3h6v6"></path><path d="M10 14 21 3"></path><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path></svg></a></nav><div class="ml-auto flex items-center gap-3"><div class="inline-flex items-center gap-1.5"><a href="https://github.com/inputlayer/inputlayer" target="_blank" rel="noopener noreferrer" class="inline-flex items-center gap-1.5 rounded-md border border-border bg-secondary/50 px-2.5 py-1 text-xs font-medium text-muted-foreground transition-colors hover:text-foreground hover:bg-secondary"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-star h-3.5 w-3.5"><path d="M11.525 2.295a.53.53 0 0 1 .95 0l2.31 4.679a2.123 2.123 0 0 0 1.595 1.16l5.166.756a.53.53 0 0 1 .294.904l-3.736 3.638a2.123 2.123 0 0 0-.611 1.878l.882 5.14a.53.53 0 0 1-.771.56l-4.618-2.428a2.122 2.122 0 0 0-1.973 0L6.396 21.01a.53.53 0 0 1-.77-.56l.881-5.139a2.122 2.122 0 0 0-.611-1.879L2.16 9.795a.53.53 0 0 1 .294-.906l5.165-.755a2.122 2.122 0 0 0 1.597-1.16z"></path></svg><span>Star</span></a><a href="https://github.com/inputlayer/inputlayer/fork" target="_blank" rel="noopener noreferrer" class="inline-flex items-center gap-1.5 rounded-md border border-border bg-secondary/50 px-2.5 py-1 text-xs font-medium text-muted-foreground transition-colors hover:text-foreground hover:bg-secondary"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-git-fork h-3.5 w-3.5"><circle cx="12" cy="18" r="3"></circle><circle cx="6" cy="6" r="3"></circle><circle cx="18" cy="6" r="3"></circle><path d="M18 9v2c0 .6-.4 1-1 1H7c-.6 0-1-.4-1-1V9"></path><path d="M12 12v3"></path></svg><span>Fork</span></a></div><button data-slot="button" class="inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-md text-sm font-medium transition-all disabled:pointer-events-none disabled:opacity-50 [&amp;_svg]:pointer-events-none [&amp;_svg:not([class*=&#x27;size-&#x27;])]:size-4 shrink-0 [&amp;_svg]:shrink-0 outline-none focus-visible:border-ring focus-visible:ring-ring/50 focus-visible:ring-[3px] aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive hover:bg-accent hover:text-accent-foreground dark:hover:bg-accent/50 size-9 h-9 w-9"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-sun h-4 w-4"><circle cx="12" cy="12" r="4"></circle><path d="M12 2v2"></path><path d="M12 20v2"></path><path d="m4.93 4.93 1.41 1.41"></path><path d="m17.66 17.66 1.41 1.41"></path><path d="M2 12h2"></path><path d="M20 12h2"></path><path d="m6.34 17.66-1.41 1.41"></path><path d="m19.07 4.93-1.41 1.41"></path></svg></button><div class="md:hidden"><button class="inline-flex items-center justify-center rounded-md p-2 text-muted-foreground hover:text-foreground hover:bg-secondary transition-colors" aria-label="Open menu"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-menu h-5 w-5"><line x1="4" x2="20" y1="12" y2="12"></line><line x1="4" x2="20" y1="6" y2="6"></line><line x1="4" x2="20" y1="18" y2="18"></line></svg></button></div></div></div></header><div class="flex flex-1 overflow-hidden"><div class="w-64 shrink-0 border-r border-border/50 overflow-y-auto"><div class="flex flex-col h-full"><div class="p-3 border-b border-border/50"><div class="relative"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-search absolute left-2.5 top-1/2 -translate-y-1/2 h-3.5 w-3.5 text-muted-foreground"><circle cx="11" cy="11" r="8"></circle><path d="m21 21-4.3-4.3"></path></svg><input type="text" placeholder="Search docs..." class="w-full h-8 pl-8 pr-3 text-sm rounded-md border border-border bg-background placeholder:text-muted-foreground focus:outline-none focus:ring-1 focus:ring-ring" value=""/></div></div><nav class="flex-1 overflow-y-auto p-2 space-y-0.5"><a class="block py-1.5 px-3 text-sm rounded-md transition-colors text-muted-foreground hover:bg-muted hover:text-foreground" style="padding-left:12px" href="/docs/index/">Overview</a><div data-state="closed" data-slot="collapsible"><button class="w-full flex items-center w-full py-1.5 px-3 text-sm rounded-md transition-colors text-muted-foreground hover:bg-muted hover:text-foreground" style="padding-left:12px" type="button" aria-controls="radix-_R_j6av5ubtb_" aria-expanded="false" data-state="closed" data-slot="collapsible-trigger"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-chevron-right h-3.5 w-3.5 mr-1 shrink-0 transition-transform"><path d="m9 18 6-6-6-6"></path></svg>Guides</button><div data-state="closed" id="radix-_R_j6av5ubtb_" hidden="" data-slot="collapsible-content"></div></div><div data-state="closed" data-slot="collapsible"><button class="w-full flex items-center w-full py-1.5 px-3 text-sm rounded-md transition-colors text-muted-foreground hover:bg-muted hover:text-foreground" style="padding-left:12px" type="button" aria-controls="radix-_R_r6av5ubtb_" aria-expanded="false" data-state="closed" data-slot="collapsible-trigger"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-chevron-right h-3.5 w-3.5 mr-1 shrink-0 transition-transform"><path d="m9 18 6-6-6-6"></path></svg>Reference</button><div data-state="closed" id="radix-_R_r6av5ubtb_" hidden="" data-slot="collapsible-content"></div></div><div data-state="closed" data-slot="collapsible"><button class="w-full flex items-center w-full py-1.5 px-3 text-sm rounded-md transition-colors text-muted-foreground hover:bg-muted hover:text-foreground" style="padding-left:12px" type="button" aria-controls="radix-_R_136av5ubtb_" aria-expanded="false" data-state="closed" data-slot="collapsible-trigger"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-chevron-right h-3.5 w-3.5 mr-1 shrink-0 transition-transform"><path d="m9 18 6-6-6-6"></path></svg>Specification</button><div data-state="closed" id="radix-_R_136av5ubtb_" hidden="" data-slot="collapsible-content"></div></div><div data-state="open" data-slot="collapsible"><button class="w-full flex items-center w-full py-1.5 px-3 text-sm rounded-md transition-colors text-foreground font-medium" style="padding-left:12px" type="button" aria-controls="radix-_R_1b6av5ubtb_" aria-expanded="true" data-state="open" data-slot="collapsible-trigger"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-chevron-right h-3.5 w-3.5 mr-1 shrink-0 transition-transform rotate-90"><path d="m9 18 6-6-6-6"></path></svg>Internals</button><div data-state="open" id="radix-_R_1b6av5ubtb_" data-slot="collapsible-content"><a class="block py-1.5 px-3 text-sm rounded-md transition-colors text-muted-foreground hover:bg-muted hover:text-foreground" style="padding-left:24px" href="/docs/internals/index/">Overview</a><a class="block py-1.5 px-3 text-sm rounded-md transition-colors bg-primary/10 text-primary font-medium" style="padding-left:24px" href="/docs/internals/architecture/">Architecture</a><a class="block py-1.5 px-3 text-sm rounded-md transition-colors text-muted-foreground hover:bg-muted hover:text-foreground" style="padding-left:24px" href="/docs/internals/coding-standards/">Coding Standards</a><a class="block py-1.5 px-3 text-sm rounded-md transition-colors text-muted-foreground hover:bg-muted hover:text-foreground" style="padding-left:24px" href="/docs/internals/type-system/">Type System</a><a class="block py-1.5 px-3 text-sm rounded-md transition-colors text-muted-foreground hover:bg-muted hover:text-foreground" style="padding-left:24px" href="/docs/internals/validation/">Validation</a><a class="block py-1.5 px-3 text-sm rounded-md transition-colors text-muted-foreground hover:bg-muted hover:text-foreground" style="padding-left:24px" href="/docs/internals/record-syntax/">Record Syntax</a><a class="block py-1.5 px-3 text-sm rounded-md transition-colors text-muted-foreground hover:bg-muted hover:text-foreground" style="padding-left:24px" href="/docs/internals/roadmap/">Roadmap</a></div></div></nav></div></div><div class="flex flex-1 flex-col overflow-hidden"><div class="flex flex-1 overflow-hidden"><div class="flex-1 overflow-y-auto px-8 py-6 max-w-4xl mx-auto"><article class="docs-prose"><h1 id="inputlayer-architecture" node="[object Object]">InputLayer Architecture</h1>
<p><strong>Version</strong>: 3.0 (Production-Ready)
<strong>Date</strong>: 2026-02-05
<strong>Status</strong>: All architectural issues resolved, ready for HNSW indexing</p>
<hr/>
<h2 id="overview" node="[object Object]">Overview</h2>
<p>InputLayer is an incremental database engine built on Differential Dataflow (DD). The architecture supports:</p>
<ul>
<li><strong>Persistent incremental computation</strong> via DDComputation with shared arrangements</li>
<li><strong>Lock-free concurrent reads</strong> via ArcSwap snapshot system</li>
<li><strong>Rule materialization</strong> with automatic cascade invalidation</li>
<li><strong>Session isolation</strong> for ephemeral facts and rules</li>
<li><strong>Multi-worker parallel execution</strong> for batch queries</li>
</ul>
<p><strong>Test Coverage</strong>: ~3107 unit tests + ~1121 snapshot tests = ~4228 total, all passing.</p>
<hr/>
<h2 id="1-architecture-overview" node="[object Object]">1. Architecture Overview</h2>
<pre class="rounded-lg bg-[var(--code-bg)] p-4 overflow-x-auto mb-4 text-sm font-mono" node="[object Object]"><code class="bg-muted rounded px-1.5 py-0.5 font-mono text-sm" node="[object Object]">+-----------------------------------------------------------------------------+
|                              StorageEngine                                    |
|                    DashMap&lt;String, Arc&lt;RwLock&lt;KnowledgeGraph&gt;&gt;&gt;              |
|                                                                               |
|  +-------------------------------------------------------------------------+ |
|  |                        KnowledgeGraph                                    | |
|  |                                                                          | |
|  |  +--------------------+  +--------------------+  +-------------------+  | |
|  |  |   DatalogEngine    |  |    RuleCatalog     |  |  DDComputation    |  | |
|  |  |                    |  |                    |  |   (Optional)      |  | |
|  |  | input_tuples:      |  | rules: HashMap     |  |                   |  | |
|  |  |   HashMap&lt;String,  |  | catalog.json       |  | InputSessions     |  | |
|  |  |   Vec&lt;Tuple&gt;&gt;      |  |                    |  | TraceAgents       |  | |
|  |  |                    |  | Stratification     |  | Arrangements      |  | |
|  |  | num_workers: usize |  | Validation         |  | ProbeHandle&lt;u64&gt;  |  | |
|  |  +--------------------+  +--------------------+  |                   |  | |
|  |                                                   | DerivedRelations |  | |
|  |  +--------------------------------------------+  |   Manager        |  | |
|  |  |        ArcSwap&lt;KnowledgeGraphSnapshot&gt;      |  +-------------------+  | |
|  |  |                                             |                          | |
|  |  |  input_tuples: Arc&lt;HashMap&gt;                |                          | |
|  |  |  rules: Arc&lt;Vec&lt;Rule&gt;&gt;                     |                          | |
|  |  |  materialized_relations: Arc&lt;HashSet&gt;      |                          | |
|  |  |  num_workers: usize                        |                          | |
|  |  +--------------------------------------------+                          | |
|  +-------------------------------------------------------------------------+ |
|                                                                               |
|  +-------------------------------------------------------------------------+ |
|  |                          FilePersist                                     | |
|  |              WAL (Write-Ahead Log) + Parquet Batch Files                | |
|  +-------------------------------------------------------------------------+ |
+-----------------------------------------------------------------------------+
</code></pre>
<hr/>
<h2 id="2-core-components" node="[object Object]">2. Core Components</h2>
<h3 id="21-storageengine" node="[object Object]">2.1 StorageEngine</h3>
<p><strong>Purpose</strong>: Multi-knowledge-graph storage with concurrent access.</p>
<pre class="rounded-lg bg-[var(--code-bg)] p-4 overflow-x-auto mb-4 text-sm font-mono" node="[object Object]"><code class="language-rust text-sm"><span class="syn-keyword">pub</span> <span class="syn-keyword">struct</span> StorageEngine {
    knowledge_graphs: DashMap&lt;<span class="syn-builtin">String</span>, <span class="syn-builtin">Arc</span>&lt;RwLock&lt;KnowledgeGraph&gt;&gt;&gt;,
    logical_time: AtomicU64,
    persist: <span class="syn-builtin">Arc</span>&lt;FilePersist&gt;,
    config: StorageConfig,
}</code></pre>
<p><strong>Key Features</strong>:</p>
<ul>
<li><strong>DashMap</strong> enables concurrent access to different KGs without global locking</li>
<li><strong>Logical timestamps</strong> provide monotonically increasing write ordering</li>
<li><strong>Per-KG locking</strong> allows parallel queries to different knowledge graphs</li>
</ul>
<h3 id="22-knowledgegraph" node="[object Object]">2.2 KnowledgeGraph</h3>
<p><strong>Purpose</strong>: Single knowledge graph with data, rules, and optional incremental computation.</p>
<pre class="rounded-lg bg-[var(--code-bg)] p-4 overflow-x-auto mb-4 text-sm font-mono" node="[object Object]"><code class="language-rust text-sm"><span class="syn-keyword">pub</span> <span class="syn-keyword">struct</span> KnowledgeGraph {
    name: <span class="syn-builtin">String</span>,
    engine: DatalogEngine,
    rule_catalog: RuleCatalog,
    schema_catalog: SchemaCatalog,  <span class="syn-comment">// Per-KG schema isolation</span>
    snapshot: ArcSwap&lt;KnowledgeGraphSnapshot&gt;,
    dd_computation: <span class="syn-builtin">Option</span>&lt;DDComputation&gt;,
    num_workers: <span class="syn-keyword">usize</span>,
}</code></pre>
<p><strong>Key Features</strong>:</p>
<ul>
<li><strong>DatalogEngine</strong>: Holds base relation data (<code class="bg-muted rounded px-1.5 py-0.5 font-mono text-sm" node="[object Object]">input_tuples</code>, private with accessors)</li>
<li><strong>RuleCatalog</strong>: Persistent rule storage with stratification validation</li>
<li><strong>SchemaCatalog</strong>: Per-KG schema validation (isolated from other KGs)</li>
<li><strong>Snapshot</strong>: Lock-free point-in-time consistent views via ArcSwap</li>
<li><strong>DDComputation</strong>: Optional persistent incremental computation (returns <code class="bg-muted rounded px-1.5 py-0.5 font-mono text-sm" node="[object Object]">Result</code>)</li>
</ul>
<h3 id="23-knowledgegraphsnapshot" node="[object Object]">2.3 KnowledgeGraphSnapshot</h3>
<p><strong>Purpose</strong>: Immutable point-in-time view for lock-free reads.</p>
<pre class="rounded-lg bg-[var(--code-bg)] p-4 overflow-x-auto mb-4 text-sm font-mono" node="[object Object]"><code class="language-rust text-sm"><span class="syn-keyword">pub</span> <span class="syn-keyword">struct</span> KnowledgeGraphSnapshot {
    version: <span class="syn-keyword">u64</span>,
    timestamp: <span class="syn-keyword">u64</span>,
    input_tuples: <span class="syn-builtin">Arc</span>&lt;<span class="syn-builtin">HashMap</span>&lt;<span class="syn-builtin">String</span>, <span class="syn-builtin">Vec</span>&lt;Tuple&gt;&gt;&gt;,
    rules: <span class="syn-builtin">Arc</span>&lt;<span class="syn-builtin">Vec</span>&lt;Rule&gt;&gt;,
    materialized_relations: <span class="syn-builtin">Arc</span>&lt;<span class="syn-builtin">HashSet</span>&lt;<span class="syn-builtin">String</span>&gt;&gt;,
    num_workers: <span class="syn-keyword">usize</span>,
}</code></pre>
<p><strong>Key Features</strong>:</p>
<ul>
<li><strong>Arc-wrapped data</strong> enables O(1) clone operations</li>
<li><strong>ArcSwap</strong> provides atomic snapshot publication</li>
<li><strong>Materialization awareness</strong> skips rules for already-materialized relations</li>
<li><strong>Session isolation</strong> via <code class="bg-muted rounded px-1.5 py-0.5 font-mono text-sm" node="[object Object]">execute_with_session_facts()</code> method</li>
</ul>
<h3 id="24-ddcomputation" node="[object Object]">2.4 DDComputation</h3>
<p><strong>Purpose</strong>: Persistent incremental computation with shared arrangements.</p>
<pre class="rounded-lg bg-[var(--code-bg)] p-4 overflow-x-auto mb-4 text-sm font-mono" node="[object Object]"><code class="language-rust text-sm"><span class="syn-keyword">pub</span> <span class="syn-keyword">struct</span> DDComputation {
    command_tx: Sender&lt;DDCommand&gt;,
    current_time: <span class="syn-builtin">Arc</span>&lt;AtomicU64&gt;,
    max_write_time: <span class="syn-builtin">Arc</span>&lt;AtomicU64&gt;,
    derived_relations: <span class="syn-builtin">Arc</span>&lt;Mutex&lt;DerivedRelationsManager&gt;&gt;,
    known_relations: Mutex&lt;<span class="syn-builtin">HashSet</span>&lt;<span class="syn-builtin">String</span>&gt;&gt;,
    worker_handle: <span class="syn-builtin">Option</span>&lt;JoinHandle&lt;()&gt;&gt;,
}</code></pre>
<p><strong>Architecture</strong>:</p>
<pre class="rounded-lg bg-[var(--code-bg)] p-4 overflow-x-auto mb-4 text-sm font-mono" node="[object Object]"><code class="bg-muted rounded px-1.5 py-0.5 font-mono text-sm" node="[object Object]">Main Thread --command_tx--&gt; DD Worker Thread
                            +- Owns timely Worker&lt;u64&gt;
                            +- Owns InputSessions per relation
                            +- Owns TraceAgents (arrangements)
                            +- Steps worker in event loop
                            +- Processes commands between steps
</code></pre>
<p><strong>Command Protocol</strong>:</p>
<pre class="rounded-lg bg-[var(--code-bg)] p-4 overflow-x-auto mb-4 text-sm font-mono" node="[object Object]"><code class="language-rust text-sm"><span class="syn-keyword">enum</span> DDCommand {
    InsertDelta { relation, updates: <span class="syn-builtin">Vec</span>&lt;(Tuple, <span class="syn-keyword">u64</span>, <span class="syn-keyword">isize</span>)&gt; },
    AdvanceTime(<span class="syn-keyword">u64</span>),
    WaitUntilCaughtUp(<span class="syn-keyword">u64</span>, oneshot::Sender&lt;()&gt;),
    AddRelation(<span class="syn-builtin">String</span>),
    RegisterRule { name, dependencies },
    RemoveRule(<span class="syn-builtin">String</span>),
    SetMaterialized { relation, tuples },
    NotifyBaseUpdate(<span class="syn-builtin">String</span>),
    ReadRelation(<span class="syn-builtin">String</span>, oneshot::Sender&lt;<span class="syn-builtin">Vec</span>&lt;Tuple&gt;&gt;),
    Shutdown,
}</code></pre>
<h3 id="25-derivedrelationsmanager" node="[object Object]">2.5 DerivedRelationsManager</h3>
<p><strong>Purpose</strong>: Manage materialized derived relations with validity tracking.</p>
<pre class="rounded-lg bg-[var(--code-bg)] p-4 overflow-x-auto mb-4 text-sm font-mono" node="[object Object]"><code class="language-rust text-sm"><span class="syn-keyword">pub</span> <span class="syn-keyword">struct</span> DerivedRelationsManager {
    compiled_rules: <span class="syn-builtin">HashMap</span>&lt;<span class="syn-builtin">String</span>, CompiledRule&gt;,
    materialized: <span class="syn-builtin">HashMap</span>&lt;<span class="syn-builtin">String</span>, MaterializedRelation&gt;,
    base_to_derived: <span class="syn-builtin">HashMap</span>&lt;<span class="syn-builtin">String</span>, <span class="syn-builtin">HashSet</span>&lt;<span class="syn-builtin">String</span>&gt;&gt;,
    derived_to_derived: <span class="syn-builtin">HashMap</span>&lt;<span class="syn-builtin">String</span>, <span class="syn-builtin">HashSet</span>&lt;<span class="syn-builtin">String</span>&gt;&gt;,
    base_versions: <span class="syn-builtin">HashMap</span>&lt;<span class="syn-builtin">String</span>, <span class="syn-keyword">u64</span>&gt;,
}

<span class="syn-keyword">pub</span> <span class="syn-keyword">struct</span> MaterializedRelation {
    tuples: <span class="syn-builtin">Vec</span>&lt;Tuple&gt;,
    version: <span class="syn-keyword">u64</span>,
    base_versions: <span class="syn-builtin">HashMap</span>&lt;<span class="syn-builtin">String</span>, <span class="syn-keyword">u64</span>&gt;,
    valid: <span class="syn-keyword">bool</span>,
    materialized_at: <span class="syn-keyword">u64</span>,
}</code></pre>
<p><strong>Key Features</strong>:</p>
<ul>
<li><strong>Dependency tracking</strong> maps base relations to derived relations</li>
<li><strong>Cascade invalidation</strong> automatically invalidates dependent materializations</li>
<li><strong>Validity tracking</strong> ensures queries see consistent data</li>
<li><strong>Version management</strong> for optimistic concurrency</li>
</ul>
<hr/>
<h2 id="3-data-flow-paths" node="[object Object]">3. Data Flow Paths</h2>
<h3 id="31-write-path" node="[object Object]">3.1 Write Path</h3>
<pre class="rounded-lg bg-[var(--code-bg)] p-4 overflow-x-auto mb-4 text-sm font-mono" node="[object Object]"><code class="bg-muted rounded px-1.5 py-0.5 font-mono text-sm" node="[object Object]">Insert Request
    |
    v
FilePersist.append() --------------------------&gt; Durability (WAL)
    |
    v
KnowledgeGraph.insert_in_memory()
    |
    +-&gt; engine.input_tuples.insert() -----------&gt; In-memory state
    |
    +-&gt; DDComputation.insert() (if enabled)
        |
        +-&gt; InputSession.update(tuple, time, +1)
        |
        +-&gt; notify_base_update() ---------------&gt; Cascade invalidation
            |
            +-&gt; Invalidate dependent materializations
    |
    v
auto_rematerialize_invalid_rules() -------------&gt; Recompute materializations
    |
    v
publish_snapshot() -----------------------------&gt; Atomic snapshot publication
    |
    +-&gt; Merge valid materializations into input_tuples
    |
    +-&gt; ArcSwap.store(new_snapshot)
</code></pre>
<h3 id="32-read-path-query" node="[object Object]">3.2 Read Path (Query)</h3>
<pre class="rounded-lg bg-[var(--code-bg)] p-4 overflow-x-auto mb-4 text-sm font-mono" node="[object Object]"><code class="bg-muted rounded px-1.5 py-0.5 font-mono text-sm" node="[object Object]">Query Request
    |
    v
Handler.query_program()
    |
    +-&gt; Validate session rules -----------------&gt; validate_rule()
    |
    +-&gt; Parse statements
    |
    +-&gt; Collect session facts and rules
    |
    v
StorageEngine.execute_query_with_session_facts_on()
    |
    v
KnowledgeGraphSnapshot.execute_with_session_facts()
    |
    +-&gt; Clone input_tuples (isolated copy)
    |
    +-&gt; Add session facts to clone
    |
    +-&gt; Build combined program:
    |   +-&gt; Persistent rules (skip if materialized)
    |   +-&gt; Session rules
    |   +-&gt; Query
    |
    +-&gt; DatalogEngine.execute_tuples()
        |
        +-&gt; CodeGenerator with num_workers config
    |
    v
Results (concurrent queries unaffected)
</code></pre>
<h3 id="33-materialization-flow" node="[object Object]">3.3 Materialization Flow</h3>
<pre class="rounded-lg bg-[var(--code-bg)] p-4 overflow-x-auto mb-4 text-sm font-mono" node="[object Object]"><code class="bg-muted rounded px-1.5 py-0.5 font-mono text-sm" node="[object Object]">Rule Registration
    |
    v
RuleCatalog.register_rule()
    |
    +-&gt; Stratification validation
    |
    +-&gt; DDComputation.register_rule()
        |
        +-&gt; DerivedRelationsManager.register_rule()
    |
    v
auto_materialize_rule()
    |
    +-&gt; Execute rule against current data
    |
    +-&gt; DDComputation.set_materialized()
    |
    v
publish_snapshot()
    |
    +-&gt; Merge materialized tuples into snapshot
    |
    +-&gt; Record materialized_relations set
</code></pre>
<hr/>
<h2 id="4-consistency-guarantees" node="[object Object]">4. Consistency Guarantees</h2>
<h3 id="41-snapshot-consistency" node="[object Object]">4.1 Snapshot Consistency</h3>
<p><strong>Guarantee</strong>: Point-in-time consistent views via immutable Arc-wrapped data.</p>
<ul>
<li>Readers get consistent snapshots without holding locks</li>
<li>Snapshot cloning is O(1) due to Arc sharing</li>
<li>Session facts isolation via cloned HashMap</li>
<li>No TOCTOU vulnerabilities (lock held through publication)</li>
</ul>
<h3 id="42-write-consistency" node="[object Object]">4.2 Write Consistency</h3>
<p><strong>Guarantee</strong>: All writes are durable before acknowledgment.</p>
<ul>
<li>WAL append before in-memory update</li>
<li>DD shadow writes propagate with proper timestamps</li>
<li>Cascade invalidation is atomic (compute-then-apply pattern)</li>
</ul>
<h3 id="43-read-after-write-consistency" node="[object Object]">4.3 Read-After-Write Consistency</h3>
<p><strong>Guarantee</strong>: Via <code class="bg-muted rounded px-1.5 py-0.5 font-mono text-sm" node="[object Object]">read_relation_consistent()</code> in DDComputation.</p>
<pre class="rounded-lg bg-[var(--code-bg)] p-4 overflow-x-auto mb-4 text-sm font-mono" node="[object Object]"><code class="language-rust text-sm"><span class="syn-keyword">pub</span> <span class="syn-keyword">fn</span> read_relation_consistent(<span class="syn-operator">&amp;</span><span class="syn-keyword">self</span>, relation: <span class="syn-operator">&amp;</span><span class="syn-keyword">str</span>) -&gt; <span class="syn-builtin">Result</span>&lt;<span class="syn-builtin">Vec</span>&lt;Tuple&gt;&gt; {
    <span class="syn-comment">// 1. Advance time to max_write_time + 1</span>
    <span class="syn-comment">// 2. Wait for DD frontier to pass</span>
    <span class="syn-comment">// 3. Read from arrangement cursor</span>
}</code></pre>
<h3 id="44-session-isolation" node="[object Object]">4.4 Session Isolation</h3>
<p><strong>Guarantee</strong>: Session facts and rules don&#x27;t affect concurrent queries.</p>
<pre class="rounded-lg bg-[var(--code-bg)] p-4 overflow-x-auto mb-4 text-sm font-mono" node="[object Object]"><code class="language-rust text-sm"><span class="syn-keyword">pub</span> <span class="syn-keyword">fn</span> execute_with_session_facts(
    <span class="syn-operator">&amp;</span><span class="syn-keyword">self</span>,
    program: <span class="syn-operator">&amp;</span><span class="syn-keyword">str</span>,
    session_facts: <span class="syn-builtin">Vec</span>&lt;(<span class="syn-builtin">String</span>, Tuple)&gt;,
) -&gt; <span class="syn-builtin">Result</span>&lt;<span class="syn-builtin">Vec</span>&lt;Tuple&gt;&gt; {
    <span class="syn-comment">// Clone input_tuples (isolated copy)</span>
    <span class="syn-keyword">let</span> <span class="syn-keyword">mut</span> isolated = (*<span class="syn-keyword">self</span>.input_tuples).clone();

    <span class="syn-comment">// Add session facts to the clone</span>
    <span class="syn-keyword">for</span> (relation, tuple) <span class="syn-keyword">in</span> session_facts {
        isolated.entry(relation).or_default().push(tuple);
    }

    <span class="syn-comment">// Execute against isolated state</span>
    <span class="syn-comment">// ...</span>
}</code></pre>
<hr/>
<h2 id="5-rule-system" node="[object Object]">5. Rule System</h2>
<h3 id="51-persistent-rules-object-object-prefix" node="[object Object]">5.1 Persistent Rules (<code class="bg-muted rounded px-1.5 py-0.5 font-mono text-sm" node="[object Object]">+</code> prefix)</h3>
<pre class="rounded-lg bg-[var(--code-bg)] p-4 overflow-x-auto mb-4 text-sm font-mono" node="[object Object]"><code class="language-datalog text-sm"><span class="syn-arith">+</span><span class="syn-identifier">path</span><span class="syn-punct">(</span><span class="syn-variable">X</span><span class="syn-punct">,</span> <span class="syn-variable">Y</span><span class="syn-punct">)</span> <span class="syn-arrow">&lt;-</span> <span class="syn-body-id">edge</span><span class="syn-punct">(</span><span class="syn-variable">X</span><span class="syn-punct">,</span> <span class="syn-variable">Y</span><span class="syn-punct">)</span>
<span class="syn-arith">+</span><span class="syn-identifier">path</span><span class="syn-punct">(</span><span class="syn-variable">X</span><span class="syn-punct">,</span> <span class="syn-variable">Z</span><span class="syn-punct">)</span> <span class="syn-arrow">&lt;-</span> <span class="syn-body-id">path</span><span class="syn-punct">(</span><span class="syn-variable">X</span><span class="syn-punct">,</span> <span class="syn-variable">Y</span><span class="syn-punct">)</span><span class="syn-punct">,</span> <span class="syn-body-id">edge</span><span class="syn-punct">(</span><span class="syn-variable">Y</span><span class="syn-punct">,</span> <span class="syn-variable">Z</span><span class="syn-punct">)</span>
</code></pre>
<p><strong>Characteristics</strong>:</p>
<ul>
<li>Stored in RuleCatalog (JSON persistence)</li>
<li>Registered with DDComputation for dependency tracking</li>
<li>Auto-materialized on registration and base data changes</li>
<li>Cascade invalidation when dependencies change</li>
</ul>
<h3 id="52-session-rules-no-prefix" node="[object Object]">5.2 Session Rules (no prefix)</h3>
<pre class="rounded-lg bg-[var(--code-bg)] p-4 overflow-x-auto mb-4 text-sm font-mono" node="[object Object]"><code class="language-datalog text-sm"><span class="syn-identifier">reachable_from</span><span class="syn-punct">(</span><span class="syn-variable">Y</span><span class="syn-punct">)</span> <span class="syn-arrow">&lt;-</span> <span class="syn-body-id">path</span><span class="syn-punct">(</span><span class="syn-number">1</span><span class="syn-punct">,</span> <span class="syn-variable">Y</span><span class="syn-punct">)</span>
<span class="syn-query">?</span><span class="syn-identifier">reachable_from</span><span class="syn-punct">(</span><span class="syn-variable">X</span><span class="syn-punct">)</span>
</code></pre>
<p><strong>Characteristics</strong>:</p>
<ul>
<li>Ephemeral (per-request lifecycle)</li>
<li>Validated for stratification before execution</li>
<li>Can reference materialized persistent rules</li>
<li>Computed fresh each time (not cached)</li>
</ul>
<h3 id="53-rule-validation" node="[object Object]">5.3 Rule Validation</h3>
<pre class="rounded-lg bg-[var(--code-bg)] p-4 overflow-x-auto mb-4 text-sm font-mono" node="[object Object]"><code class="language-rust text-sm"><span class="syn-comment">/// Validate single rule (self-negation, head safety, range restriction)</span>
<span class="syn-keyword">pub</span> <span class="syn-keyword">fn</span> validate_rule(rule: <span class="syn-operator">&amp;</span>Rule, name: <span class="syn-operator">&amp;</span><span class="syn-keyword">str</span>) -&gt; <span class="syn-builtin">Result</span>&lt;(), <span class="syn-builtin">String</span>&gt;;

<span class="syn-comment">/// Validate rule set for stratification (negation cycles)</span>
<span class="syn-keyword">pub</span> <span class="syn-keyword">fn</span> validate_rules_stratification(rules: <span class="syn-operator">&amp;</span>[Rule]) -&gt; <span class="syn-builtin">Result</span>&lt;(), <span class="syn-builtin">String</span>&gt;;</code></pre>
<p><strong>Checks</strong>:</p>
<ul>
<li><strong>Self-negation</strong>: Can&#x27;t negate own head</li>
<li><strong>Head variable safety</strong>: All head variables must be bound by positive atoms</li>
<li><strong>Range restriction</strong>: Variables in negated atoms must be bound by positive atoms</li>
<li><strong>Stratification</strong>: No mutual negation cycles</li>
</ul>
<hr/>
<h2 id="6-data-types" node="[object Object]">6. Data Types</h2>
<h3 id="61-unified-tuple-format" node="[object Object]">6.1 Unified Tuple Format</h3>
<pre class="rounded-lg bg-[var(--code-bg)] p-4 overflow-x-auto mb-4 text-sm font-mono" node="[object Object]"><code class="language-rust text-sm"><span class="syn-keyword">pub</span> <span class="syn-keyword">struct</span> Tuple(<span class="syn-keyword">pub</span> <span class="syn-builtin">Vec</span>&lt;Value&gt;);

<span class="syn-keyword">pub</span> <span class="syn-keyword">enum</span> Value {
    Null,
    Bool(<span class="syn-keyword">bool</span>),
    Int(<span class="syn-keyword">i64</span>),
    Float(<span class="syn-keyword">f64</span>),
    <span class="syn-builtin">String</span>(<span class="syn-builtin">Arc</span>&lt;<span class="syn-builtin">String</span>&gt;),
    Vector(<span class="syn-builtin">Arc</span>&lt;<span class="syn-builtin">Vec</span>&lt;<span class="syn-keyword">f32</span>&gt;&gt;),
    VectorInt8(<span class="syn-builtin">Arc</span>&lt;<span class="syn-builtin">Vec</span>&lt;<span class="syn-keyword">i8</span>&gt;&gt;),
}</code></pre>
<p><strong>Key Features</strong>:</p>
<ul>
<li><strong>Single format</strong> throughout the system (Tuple2 removed)</li>
<li><strong>Arbitrary arity</strong> tuples</li>
<li><strong>Vector support</strong> for similarity search</li>
<li><strong>Abomonation</strong> implemented for multi-worker DD</li>
</ul>
<h3 id="62-abomonation-implementation" node="[object Object]">6.2 Abomonation Implementation</h3>
<pre class="rounded-lg bg-[var(--code-bg)] p-4 overflow-x-auto mb-4 text-sm font-mono" node="[object Object]"><code class="language-rust text-sm"><span class="syn-comment">// Proper entomb/exhume for multi-worker DD communication</span>
<span class="syn-keyword">unsafe</span> <span class="syn-keyword">impl</span> Abomonation <span class="syn-keyword">for</span> Value {
    <span class="syn-keyword">unsafe</span> <span class="syn-keyword">fn</span> entomb&lt;W: Write&gt;(<span class="syn-operator">&amp;</span><span class="syn-keyword">self</span>, write: <span class="syn-operator">&amp;mut</span> W) -&gt; IoResult&lt;()&gt; {
        <span class="syn-comment">// Write tag + data in custom format</span>
    }

    <span class="syn-keyword">unsafe</span> <span class="syn-keyword">fn</span> exhume&lt;<span class="syn-operator">'b</span>&gt;(<span class="syn-operator">&amp;mut</span> <span class="syn-keyword">self</span>, bytes: <span class="syn-operator">&amp;</span><span class="syn-operator">'b</span> <span class="syn-keyword">mut</span> [<span class="syn-keyword">u8</span>]) -&gt; <span class="syn-builtin">Option</span>&lt;<span class="syn-operator">&amp;</span><span class="syn-operator">'b</span> <span class="syn-keyword">mut</span> [<span class="syn-keyword">u8</span>]&gt; {
        <span class="syn-comment">// Reconstruct Value from bytes with proper Arc allocations</span>
    }
}</code></pre>
<h3 id="63-ast-display-implementations" node="[object Object]">6.3 AST Display Implementations</h3>
<p>All AST types implement <code class="bg-muted rounded px-1.5 py-0.5 font-mono text-sm" node="[object Object]">Display</code> for consistent Datalog text formatting:</p>
<pre class="rounded-lg bg-[var(--code-bg)] p-4 overflow-x-auto mb-4 text-sm font-mono" node="[object Object]"><code class="language-rust text-sm"><span class="syn-keyword">impl</span> Display <span class="syn-keyword">for</span> Term { ... }      <span class="syn-comment">// Variables, constants, aggregates, etc.</span>
<span class="syn-keyword">impl</span> Display <span class="syn-keyword">for</span> Atom { ... }      <span class="syn-comment">// relation(arg1, arg2, ...)</span>
<span class="syn-keyword">impl</span> Display <span class="syn-keyword">for</span> BodyPredicate { ... }  <span class="syn-comment">// Positive, negated, comparison</span>
<span class="syn-keyword">impl</span> Display <span class="syn-keyword">for</span> Rule { ... }      <span class="syn-comment">// head &lt;- body</span>
<span class="syn-keyword">impl</span> Display <span class="syn-keyword">for</span> ArithExpr { ... } <span class="syn-comment">// Arithmetic expressions</span>
<span class="syn-keyword">impl</span> Display <span class="syn-keyword">for</span> AggregateFunc { ... }  <span class="syn-comment">// count, sum, top_k&lt;...&gt;, etc.</span>
<span class="syn-keyword">impl</span> Display <span class="syn-keyword">for</span> ComparisonOp { ... }   <span class="syn-comment">// =, !=, &lt;, &lt;=, &gt;, &gt;=</span></code></pre>
<p><strong>Usage</strong>: All components use <code class="bg-muted rounded px-1.5 py-0.5 font-mono text-sm" node="[object Object]">term.to_string()</code> instead of duplicate formatting functions.</p>
<hr/>
<h2 id="7-execution-model" node="[object Object]">7. Execution Model</h2>
<h3 id="71-batch-execution-codegenerator" node="[object Object]">7.1 Batch Execution (CodeGenerator)</h3>
<pre class="rounded-lg bg-[var(--code-bg)] p-4 overflow-x-auto mb-4 text-sm font-mono" node="[object Object]"><code class="language-rust text-sm"><span class="syn-keyword">pub</span> <span class="syn-keyword">struct</span> CodeGenerator {
    input_data: <span class="syn-builtin">HashMap</span>&lt;<span class="syn-builtin">String</span>, <span class="syn-builtin">Vec</span>&lt;Tuple&gt;&gt;,
}

<span class="syn-keyword">pub</span> <span class="syn-keyword">struct</span> ExecutionConfig {
    num_workers: <span class="syn-keyword">usize</span>,
}</code></pre>
<p><strong>Execution Paths</strong>:</p>
<ol>
<li><strong>Non-recursive</strong>: Single <code class="bg-muted rounded px-1.5 py-0.5 font-mono text-sm" node="[object Object]">execute_directly</code> call</li>
<li><strong>Transitive closure</strong>: DD iterative scope with <code class="bg-muted rounded px-1.5 py-0.5 font-mono text-sm" node="[object Object]">SemigroupVariable</code></li>
<li><strong>General recursive</strong>: DD <code class="bg-muted rounded px-1.5 py-0.5 font-mono text-sm" node="[object Object]">.iterative()</code> scope with live collections</li>
</ol>
<p><strong>Parallelization</strong>:</p>
<ul>
<li>Rayon-based parallel execution for scan/filter/map</li>
<li>Join queries use single-worker DD for correctness</li>
<li>Configurable via <code class="bg-muted rounded px-1.5 py-0.5 font-mono text-sm" node="[object Object]">num_workers</code></li>
</ul>
<h3 id="72-incremental-execution-ddcomputation" node="[object Object]">7.2 Incremental Execution (DDComputation)</h3>
<pre class="rounded-lg bg-[var(--code-bg)] p-4 overflow-x-auto mb-4 text-sm font-mono" node="[object Object]"><code class="language-rust text-sm"><span class="syn-keyword">impl</span> DDComputation {
    <span class="syn-comment">// Returns Result - no more panicking on initialization errors</span>
    <span class="syn-keyword">pub</span> <span class="syn-keyword">fn</span> new(relations: <span class="syn-builtin">Vec</span>&lt;<span class="syn-builtin">String</span>&gt;) -&gt; <span class="syn-builtin">Result</span>&lt;<span class="syn-keyword">Self</span>, <span class="syn-builtin">String</span>&gt;;

    <span class="syn-keyword">pub</span> <span class="syn-keyword">fn</span> insert(<span class="syn-operator">&amp;</span><span class="syn-keyword">self</span>, relation: <span class="syn-operator">&amp;</span><span class="syn-keyword">str</span>, tuples: <span class="syn-builtin">Vec</span>&lt;Tuple&gt;, time: <span class="syn-keyword">u64</span>) -&gt; <span class="syn-builtin">Result</span>&lt;()&gt;;
    <span class="syn-keyword">pub</span> <span class="syn-keyword">fn</span> delete(<span class="syn-operator">&amp;</span><span class="syn-keyword">self</span>, relation: <span class="syn-operator">&amp;</span><span class="syn-keyword">str</span>, tuples: <span class="syn-builtin">Vec</span>&lt;Tuple&gt;, time: <span class="syn-keyword">u64</span>) -&gt; <span class="syn-builtin">Result</span>&lt;()&gt;;
    <span class="syn-keyword">pub</span> <span class="syn-keyword">fn</span> read_relation_consistent(<span class="syn-operator">&amp;</span><span class="syn-keyword">self</span>, relation: <span class="syn-operator">&amp;</span><span class="syn-keyword">str</span>) -&gt; <span class="syn-builtin">Result</span>&lt;<span class="syn-builtin">Vec</span>&lt;Tuple&gt;&gt;;
}</code></pre>
<p><strong>Features</strong>:</p>
<ul>
<li><strong>Fire-and-forget inserts</strong>: Shadow writes don&#x27;t block query execution</li>
<li><strong>Lazy time advancement</strong>: Writes buffer, time only advances on consistent reads</li>
<li><strong>Dynamic relations</strong>: InputSessions created at runtime</li>
</ul>
<hr/>
<h2 id="8-persistence-layer" node="[object Object]">8. Persistence Layer</h2>
<h3 id="81-wal-write-ahead-log" node="[object Object]">8.1 WAL (Write-Ahead Log)</h3>
<pre class="rounded-lg bg-[var(--code-bg)] p-4 overflow-x-auto mb-4 text-sm font-mono" node="[object Object]"><code class="language-rust text-sm"><span class="syn-keyword">pub</span> <span class="syn-keyword">struct</span> Update {
    <span class="syn-keyword">pub</span> data: Tuple,
    <span class="syn-keyword">pub</span> time: <span class="syn-keyword">u64</span>,
    <span class="syn-keyword">pub</span> diff: <span class="syn-keyword">i64</span>,  <span class="syn-comment">// +1 for insert, -1 for delete</span>
}

<span class="syn-keyword">pub</span> <span class="syn-keyword">struct</span> WalEntry {
    <span class="syn-keyword">pub</span> shard: <span class="syn-builtin">String</span>,
    <span class="syn-keyword">pub</span> update: Update,
}</code></pre>
<h3 id="82-batch-files-parquet" node="[object Object]">8.2 Batch Files (Parquet)</h3>
<pre class="rounded-lg bg-[var(--code-bg)] p-4 overflow-x-auto mb-4 text-sm font-mono" node="[object Object]"><code class="language-rust text-sm"><span class="syn-keyword">pub</span> <span class="syn-keyword">struct</span> ShardMeta {
    <span class="syn-keyword">pub</span> shard: <span class="syn-builtin">String</span>,
    <span class="syn-keyword">pub</span> batches: <span class="syn-builtin">Vec</span>&lt;BatchMeta&gt;,
    <span class="syn-keyword">pub</span> since: <span class="syn-keyword">u64</span>,   <span class="syn-comment">// Compaction frontier</span>
    <span class="syn-keyword">pub</span> upper: <span class="syn-keyword">u64</span>,   <span class="syn-comment">// Write frontier</span>
}</code></pre>
<h3 id="83-recovery-sequence" node="[object Object]">8.3 Recovery Sequence</h3>
<pre class="rounded-lg bg-[var(--code-bg)] p-4 overflow-x-auto mb-4 text-sm font-mono" node="[object Object]"><code class="bg-muted rounded px-1.5 py-0.5 font-mono text-sm" node="[object Object]">1. Load shard metadata from disk
2. Create DDComputation for each KG
3. Replay batch files through InputSessions
4. Replay WAL entries since last batch
5. Step workers until frontier advances past WAL upper
6. DDComputation is live and ready
</code></pre>
<hr/>
<h2 id="9-protocol-layer" node="[object Object]">9. Protocol Layer</h2>
<h3 id="91-handler" node="[object Object]">9.1 Handler</h3>
<pre class="rounded-lg bg-[var(--code-bg)] p-4 overflow-x-auto mb-4 text-sm font-mono" node="[object Object]"><code class="language-rust text-sm"><span class="syn-keyword">pub</span> <span class="syn-keyword">struct</span> Handler {
    storage: <span class="syn-builtin">Arc</span>&lt;RwLock&lt;StorageEngine&gt;&gt;,
    start_time: Instant,
    query_count: AtomicU64,
    insert_count: AtomicU64,
}</code></pre>
<p><strong>Key Features</strong>:</p>
<ul>
<li><strong>Read lock</strong> for all query operations (concurrent queries)</li>
<li><strong>Explicit KG naming</strong> via <code class="bg-muted rounded px-1.5 py-0.5 font-mono text-sm" node="[object Object]">_on()</code>, <code class="bg-muted rounded px-1.5 py-0.5 font-mono text-sm" node="[object Object]">_into()</code>, <code class="bg-muted rounded px-1.5 py-0.5 font-mono text-sm" node="[object Object]">_from()</code> variants</li>
<li><strong>Session fact isolation</strong> via <code class="bg-muted rounded px-1.5 py-0.5 font-mono text-sm" node="[object Object]">execute_query_with_session_facts_on()</code></li>
<li><strong>Per-KG schema validation</strong> delegated to StorageEngine (schemas isolated per KG)</li>
</ul>
<h3 id="92-statement-types" node="[object Object]">9.2 Statement Types</h3>
<pre class="rounded-lg bg-[var(--code-bg)] p-4 overflow-x-auto mb-4 text-sm font-mono" node="[object Object]"><code class="language-rust text-sm"><span class="syn-keyword">pub</span> <span class="syn-keyword">enum</span> Statement {
    SchemaDecl(SchemaDecl),
    PersistentRule(Rule),      <span class="syn-comment">// +name(...) &lt;- body</span>
    SessionRule(Rule),          <span class="syn-comment">// name(...) &lt;- body</span>
    PersistentFact(Fact),      <span class="syn-comment">// +relation(values)</span>
    SessionFact(Fact),          <span class="syn-comment">// relation(values)</span>
    Query(Query),               <span class="syn-comment">// ?body</span>
    ConditionalDelete(Rule),   <span class="syn-comment">// -relation(X) &lt;- condition</span>
    DotCommand(DotCommand),    <span class="syn-comment">// .kg, .rule, .rel, etc.</span>
}</code></pre>
<hr/>
<h2 id="10-hnsw-indexing-readiness" node="[object Object]">10. HNSW Indexing Readiness</h2>
<h3 id="101-prerequisites-all-complete" node="[object Object]">10.1 Prerequisites (All Complete)</h3>
<div class="my-4 overflow-x-auto"><table class="w-full border-collapse" node="[object Object]"><thead><tr><th class="border px-4 py-2 text-left font-semibold bg-muted/50" node="[object Object]">Prerequisite</th><th class="border px-4 py-2 text-left font-semibold bg-muted/50" node="[object Object]">Status</th><th class="border px-4 py-2 text-left font-semibold bg-muted/50" node="[object Object]">Description</th></tr></thead><tbody><tr><td class="border px-4 py-2" node="[object Object]">Abomonation fix</td><td class="border px-4 py-2" node="[object Object]">Done</td><td class="border px-4 py-2" node="[object Object]">Proper exhume() for multi-worker DD</td></tr><tr><td class="border px-4 py-2" node="[object Object]">Generic timestamps</td><td class="border px-4 py-2" node="[object Object]">Done</td><td class="border px-4 py-2" node="[object Object]">CodeGenerator uses <code class="bg-muted rounded px-1.5 py-0.5 font-mono text-sm" node="[object Object]">G::Timestamp: Lattice + Ord + Default</code></td></tr><tr><td class="border px-4 py-2" node="[object Object]">DDComputation</td><td class="border px-4 py-2" node="[object Object]">Done</td><td class="border px-4 py-2" node="[object Object]">Persistent incremental computation</td></tr><tr><td class="border px-4 py-2" node="[object Object]">Insert path wiring</td><td class="border px-4 py-2" node="[object Object]">Done</td><td class="border px-4 py-2" node="[object Object]">Shadow writes to DDComputation</td></tr><tr><td class="border px-4 py-2" node="[object Object]">Consistent reads</td><td class="border px-4 py-2" node="[object Object]">Done</td><td class="border px-4 py-2" node="[object Object]">Lazy time advancement + frontier tracking</td></tr><tr><td class="border px-4 py-2" node="[object Object]">Rule materialization</td><td class="border px-4 py-2" node="[object Object]">Done</td><td class="border px-4 py-2" node="[object Object]">DerivedRelationsManager with validity tracking</td></tr><tr><td class="border px-4 py-2" node="[object Object]">Auto-materialization</td><td class="border px-4 py-2" node="[object Object]">Done</td><td class="border px-4 py-2" node="[object Object]">Persistent rules auto-materialize</td></tr><tr><td class="border px-4 py-2" node="[object Object]">Session isolation</td><td class="border px-4 py-2" node="[object Object]">Done</td><td class="border px-4 py-2" node="[object Object]">Cloned snapshots for session facts</td></tr></tbody></table></div>
<h3 id="102-hnsw-integration-points" node="[object Object]">10.2 HNSW Integration Points</h3>
<pre class="rounded-lg bg-[var(--code-bg)] p-4 overflow-x-auto mb-4 text-sm font-mono" node="[object Object]"><code class="bg-muted rounded px-1.5 py-0.5 font-mono text-sm" node="[object Object]">Insert -&gt; Persist WAL -&gt; In-Memory State -&gt; DDComputation
                                              |
                                              v
                                        Arrangement
                                              |
                                              v
                                    [HNSW INDEX SINK]
                                              |
                                    On insert: hnsw.insert(embedding, id)
                                    On delete: tombstone.add(id)
</code></pre>
<h3 id="103-required-extensions-for-hnsw" node="[object Object]">10.3 Required Extensions for HNSW</h3>
<ol>
<li><strong>IndexManager</strong> in KnowledgeGraph</li>
<li><strong>IRNode::IndexScan</strong> in IR</li>
<li><strong><code class="bg-muted rounded px-1.5 py-0.5 font-mono text-sm" node="[object Object]">.index create/drop/rebuild</code></strong> commands</li>
<li><strong>Query planning</strong> for distance predicates</li>
</ol>
<hr/>
<h2 id="11-configuration" node="[object Object]">11. Configuration</h2>
<h3 id="111-performance-configuration" node="[object Object]">11.1 Performance Configuration</h3>
<pre class="rounded-lg bg-[var(--code-bg)] p-4 overflow-x-auto mb-4 text-sm font-mono" node="[object Object]"><code class="language-toml text-sm"><span class="syn-meta">[storage.performance]</span>
<span class="syn-identifier">num_threads</span> = <span class="syn-number">4</span>       <span class="syn-comment"># Workers for parallel execution</span>
<span class="syn-identifier">batch_size</span> = <span class="syn-number">1000</span>     <span class="syn-comment"># Batch size for operations</span></code></pre>
<h3 id="112-storage-configuration" node="[object Object]">11.2 Storage Configuration</h3>
<pre class="rounded-lg bg-[var(--code-bg)] p-4 overflow-x-auto mb-4 text-sm font-mono" node="[object Object]"><code class="language-toml text-sm"><span class="syn-meta">[storage]</span>
<span class="syn-identifier">data_dir</span> = <span class="syn-string">"./data"</span>
<span class="syn-identifier">auto_create_kg</span> = <span class="syn-keyword">true</span>
<span class="syn-identifier">default_kg</span> = <span class="syn-string">"default"</span></code></pre>
<h3 id="113-environment-variables" node="[object Object]">11.3 Environment Variables</h3>
<p>All environment variables use the <code class="bg-muted rounded px-1.5 py-0.5 font-mono text-sm" node="[object Object]">IL_</code> prefix:</p>
<div class="my-4 overflow-x-auto"><table class="w-full border-collapse" node="[object Object]"><thead><tr><th class="border px-4 py-2 text-left font-semibold bg-muted/50" node="[object Object]">Variable</th><th class="border px-4 py-2 text-left font-semibold bg-muted/50" node="[object Object]">Purpose</th></tr></thead><tbody><tr><td class="border px-4 py-2" node="[object Object]"><code class="bg-muted rounded px-1.5 py-0.5 font-mono text-sm" node="[object Object]">IL_DEBUG</code></td><td class="border px-4 py-2" node="[object Object]">Enable debug output for IR building, execution, and optimization</td></tr><tr><td class="border px-4 py-2" node="[object Object]"><code class="bg-muted rounded px-1.5 py-0.5 font-mono text-sm" node="[object Object]">IL_DEBUG_SESSION</code></td><td class="border px-4 py-2" node="[object Object]">Enable debug output for session fact handling</td></tr></tbody></table></div>
<hr/>
<h2 id="12-query-optimization" node="[object Object]">12. Query Optimization</h2>
<p>InputLayer includes query optimization infrastructure for improving join performance.</p>
<h3 id="121-optimization-modules" node="[object Object]">12.1 Optimization Modules</h3>
<div class="my-4 overflow-x-auto"><table class="w-full border-collapse" node="[object Object]"><thead><tr><th class="border px-4 py-2 text-left font-semibold bg-muted/50" node="[object Object]">Module</th><th class="border px-4 py-2 text-left font-semibold bg-muted/50" node="[object Object]">File</th><th class="border px-4 py-2 text-left font-semibold bg-muted/50" node="[object Object]">Purpose</th></tr></thead><tbody><tr><td class="border px-4 py-2" node="[object Object]"><strong>Bloom Filter</strong></td><td class="border px-4 py-2" node="[object Object]"><code class="bg-muted rounded px-1.5 py-0.5 font-mono text-sm" node="[object Object]">src/bloom_filter.rs</code></td><td class="border px-4 py-2" node="[object Object]">Probabilistic set membership testing</td></tr><tr><td class="border px-4 py-2" node="[object Object]"><strong>Hash Index</strong></td><td class="border px-4 py-2" node="[object Object]"><code class="bg-muted rounded px-1.5 py-0.5 font-mono text-sm" node="[object Object]">src/hash_index.rs</code></td><td class="border px-4 py-2" node="[object Object]">O(1) join key lookups with Bloom acceleration</td></tr><tr><td class="border px-4 py-2" node="[object Object]"><strong>Statistics</strong></td><td class="border px-4 py-2" node="[object Object]"><code class="bg-muted rounded px-1.5 py-0.5 font-mono text-sm" node="[object Object]">src/statistics.rs</code></td><td class="border px-4 py-2" node="[object Object]">Cardinality and selectivity estimation</td></tr><tr><td class="border px-4 py-2" node="[object Object]"><strong>Join Planning</strong></td><td class="border px-4 py-2" node="[object Object]"><code class="bg-muted rounded px-1.5 py-0.5 font-mono text-sm" node="[object Object]">src/join_planning/mod.rs</code></td><td class="border px-4 py-2" node="[object Object]">Join ordering via MST algorithm</td></tr><tr><td class="border px-4 py-2" node="[object Object]"><strong>SIP Rewriting</strong></td><td class="border px-4 py-2" node="[object Object]"><code class="bg-muted rounded px-1.5 py-0.5 font-mono text-sm" node="[object Object]">src/sip_rewriting/mod.rs</code></td><td class="border px-4 py-2" node="[object Object]">Sideways Information Passing</td></tr><tr><td class="border px-4 py-2" node="[object Object]"><strong>Subplan Sharing</strong></td><td class="border px-4 py-2" node="[object Object]"><code class="bg-muted rounded px-1.5 py-0.5 font-mono text-sm" node="[object Object]">src/subplan_sharing/mod.rs</code></td><td class="border px-4 py-2" node="[object Object]">Common subexpression elimination</td></tr></tbody></table></div>
<h3 id="122-bloom-filter" node="[object Object]">12.2 Bloom Filter</h3>
<p>Space-efficient probabilistic data structure for fast set membership testing.</p>
<pre class="rounded-lg bg-[var(--code-bg)] p-4 overflow-x-auto mb-4 text-sm font-mono" node="[object Object]"><code class="language-rust text-sm"><span class="syn-keyword">use</span> inputlayer::bloom_filter::{BloomFilter, BloomFilterBuilder};

<span class="syn-comment">// Create filter for 10K elements with 1% false positive rate</span>
<span class="syn-keyword">let</span> <span class="syn-keyword">mut</span> filter = BloomFilter::new(<span class="syn-number">10_000</span>, <span class="syn-number">0.01</span>);
filter.insert(<span class="syn-operator">&amp;</span><span class="syn-string">"key1"</span>);
filter.insert(<span class="syn-operator">&amp;</span><span class="syn-string">"key2"</span>);

<span class="syn-comment">// Check membership (no false negatives, possible false positives)</span>
<span class="syn-keyword">if</span> filter.might_contain(<span class="syn-operator">&amp;</span><span class="syn-string">"key1"</span>) {
    <span class="syn-comment">// Definitely present or false positive</span>
}</code></pre>
<p><strong>Properties:</strong></p>
<ul>
<li>No false negatives: if <code class="bg-muted rounded px-1.5 py-0.5 font-mono text-sm" node="[object Object]">might_contain()</code> returns <code class="bg-muted rounded px-1.5 py-0.5 font-mono text-sm" node="[object Object]">false</code>, the element is definitely not present</li>
<li>Possible false positives: if <code class="bg-muted rounded px-1.5 py-0.5 font-mono text-sm" node="[object Object]">might_contain()</code> returns <code class="bg-muted rounded px-1.5 py-0.5 font-mono text-sm" node="[object Object]">true</code>, element might or might not be present</li>
<li>Space efficient: ~10 bits per element for 1% false positive rate</li>
</ul>
<h3 id="123-hash-index" node="[object Object]">12.3 Hash Index</h3>
<p>Accelerates join key lookups with Bloom filter pre-filtering.</p>
<pre class="rounded-lg bg-[var(--code-bg)] p-4 overflow-x-auto mb-4 text-sm font-mono" node="[object Object]"><code class="language-rust text-sm"><span class="syn-keyword">use</span> inputlayer::hash_index::{HashIndex, HashIndexManager, JoinKeySpec};

<span class="syn-comment">// Create index for edge(src, dst) on column 0</span>
<span class="syn-keyword">let</span> spec = JoinKeySpec::new(<span class="syn-string">"edge"</span>, vec![<span class="syn-number">0</span>]);
<span class="syn-keyword">let</span> <span class="syn-keyword">mut</span> index = HashIndex::new(spec);

<span class="syn-comment">// Build from tuples</span>
index.build_from_tuples(<span class="syn-operator">&amp;</span>edge_tuples);

<span class="syn-comment">// Lookup with Bloom filter check first</span>
<span class="syn-keyword">if</span> <span class="syn-keyword">let</span> <span class="syn-builtin">Some</span>(matching) = index.lookup(<span class="syn-operator">&amp;</span>key) {
    <span class="syn-keyword">for</span> tuple <span class="syn-keyword">in</span> matching {
        <span class="syn-comment">// Process matching tuples</span>
    }
}</code></pre>
<h3 id="124-statistics-manager" node="[object Object]">12.4 Statistics Manager</h3>
<p>Collects and maintains relation statistics for query optimization.</p>
<pre class="rounded-lg bg-[var(--code-bg)] p-4 overflow-x-auto mb-4 text-sm font-mono" node="[object Object]"><code class="language-rust text-sm"><span class="syn-keyword">use</span> inputlayer::statistics::{StatisticsManager, RelationStats};

<span class="syn-keyword">let</span> <span class="syn-keyword">mut</span> stats_manager = StatisticsManager::new();

<span class="syn-comment">// Update statistics for a relation</span>
stats_manager.update_stats(<span class="syn-string">"edge"</span>, <span class="syn-operator">&amp;</span>edge_tuples);

<span class="syn-comment">// Get cardinality estimate</span>
<span class="syn-keyword">if</span> <span class="syn-keyword">let</span> <span class="syn-builtin">Some</span>(stats) = stats_manager.get_stats(<span class="syn-string">"edge"</span>) {
    <span class="syn-builtin">println</span>!(<span class="syn-string">"Cardinality: {}"</span>, stats.cardinality);
    <span class="syn-builtin">println</span>!(<span class="syn-string">"Distinct values in col 0: {}"</span>, stats.column_stats[<span class="syn-number">0</span>].distinct_count);
}

<span class="syn-comment">// Estimate join selectivity</span>
<span class="syn-keyword">let</span> selectivity = stats_manager.estimate_join_selectivity(<span class="syn-string">"edge"</span>, <span class="syn-number">0</span>, <span class="syn-string">"node"</span>, <span class="syn-number">0</span>);</code></pre>
<h3 id="125-bloomsemijoin-ir-node" node="[object Object]">12.5 BloomSemijoin IR Node</h3>
<p>The IR includes a <code class="bg-muted rounded px-1.5 py-0.5 font-mono text-sm" node="[object Object]">BloomSemijoin</code> node for semijoin reduction:</p>
<pre class="rounded-lg bg-[var(--code-bg)] p-4 overflow-x-auto mb-4 text-sm font-mono" node="[object Object]"><code class="language-rust text-sm">IRNode::BloomSemijoin {
    input: <span class="syn-builtin">Box</span>&lt;IRNode&gt;,           <span class="syn-comment">// Relation to filter</span>
    filter_source: <span class="syn-builtin">Box</span>&lt;IRNode&gt;,   <span class="syn-comment">// Relation providing filter keys</span>
    input_key_columns: <span class="syn-builtin">Vec</span>&lt;<span class="syn-keyword">usize</span>&gt;,
    filter_key_columns: <span class="syn-builtin">Vec</span>&lt;<span class="syn-keyword">usize</span>&gt;,
    output_schema: <span class="syn-builtin">Vec</span>&lt;<span class="syn-builtin">String</span>&gt;,
}</code></pre>
<p>This node filters <code class="bg-muted rounded px-1.5 py-0.5 font-mono text-sm" node="[object Object]">input</code> to keep only tuples whose key columns exist in <code class="bg-muted rounded px-1.5 py-0.5 font-mono text-sm" node="[object Object]">filter_source</code>, implemented via Differential Dataflow&#x27;s <code class="bg-muted rounded px-1.5 py-0.5 font-mono text-sm" node="[object Object]">semijoin()</code> operator.</p>
<hr/>
<h2 id="13-file-reference" node="[object Object]">13. File Reference</h2>
<div class="my-4 overflow-x-auto"><table class="w-full border-collapse" node="[object Object]"><thead><tr><th class="border px-4 py-2 text-left font-semibold bg-muted/50" node="[object Object]">File</th><th class="border px-4 py-2 text-left font-semibold bg-muted/50" node="[object Object]">Purpose</th></tr></thead><tbody><tr><td class="border px-4 py-2" node="[object Object]"><code class="bg-muted rounded px-1.5 py-0.5 font-mono text-sm" node="[object Object]">src/lib.rs</code></td><td class="border px-4 py-2" node="[object Object]">DatalogEngine, public API</td></tr><tr><td class="border px-4 py-2" node="[object Object]"><code class="bg-muted rounded px-1.5 py-0.5 font-mono text-sm" node="[object Object]">src/ast/mod.rs</code></td><td class="border px-4 py-2" node="[object Object]">AST types with Display implementations</td></tr><tr><td class="border px-4 py-2" node="[object Object]"><code class="bg-muted rounded px-1.5 py-0.5 font-mono text-sm" node="[object Object]">src/value/mod.rs</code></td><td class="border px-4 py-2" node="[object Object]">Value, Tuple, Abomonation</td></tr><tr><td class="border px-4 py-2" node="[object Object]"><code class="bg-muted rounded px-1.5 py-0.5 font-mono text-sm" node="[object Object]">src/storage_engine/mod.rs</code></td><td class="border px-4 py-2" node="[object Object]">StorageEngine, KnowledgeGraph</td></tr><tr><td class="border px-4 py-2" node="[object Object]"><code class="bg-muted rounded px-1.5 py-0.5 font-mono text-sm" node="[object Object]">src/storage_engine/snapshot.rs</code></td><td class="border px-4 py-2" node="[object Object]">KnowledgeGraphSnapshot</td></tr><tr><td class="border px-4 py-2" node="[object Object]"><code class="bg-muted rounded px-1.5 py-0.5 font-mono text-sm" node="[object Object]">src/incremental.rs</code></td><td class="border px-4 py-2" node="[object Object]">IncrementalEngine</td></tr><tr><td class="border px-4 py-2" node="[object Object]"><code class="bg-muted rounded px-1.5 py-0.5 font-mono text-sm" node="[object Object]">src/derived_relations.rs</code></td><td class="border px-4 py-2" node="[object Object]">DerivedRelationsManager</td></tr><tr><td class="border px-4 py-2" node="[object Object]"><code class="bg-muted rounded px-1.5 py-0.5 font-mono text-sm" node="[object Object]">src/rule_catalog.rs</code></td><td class="border px-4 py-2" node="[object Object]">RuleCatalog, validation</td></tr><tr><td class="border px-4 py-2" node="[object Object]"><code class="bg-muted rounded px-1.5 py-0.5 font-mono text-sm" node="[object Object]">src/schema/catalog.rs</code></td><td class="border px-4 py-2" node="[object Object]">SchemaCatalog (per-KG)</td></tr><tr><td class="border px-4 py-2" node="[object Object]"><code class="bg-muted rounded px-1.5 py-0.5 font-mono text-sm" node="[object Object]">src/code_generator/mod.rs</code></td><td class="border px-4 py-2" node="[object Object]">CodeGenerator, execution</td></tr><tr><td class="border px-4 py-2" node="[object Object]"><code class="bg-muted rounded px-1.5 py-0.5 font-mono text-sm" node="[object Object]">src/protocol/handler.rs</code></td><td class="border px-4 py-2" node="[object Object]">Request handling</td></tr><tr><td class="border px-4 py-2" node="[object Object]"><code class="bg-muted rounded px-1.5 py-0.5 font-mono text-sm" node="[object Object]">src/storage/persist/mod.rs</code></td><td class="border px-4 py-2" node="[object Object]">FilePersist, WAL, batches</td></tr><tr><td class="border px-4 py-2" node="[object Object]"><code class="bg-muted rounded px-1.5 py-0.5 font-mono text-sm" node="[object Object]">src/bloom_filter.rs</code></td><td class="border px-4 py-2" node="[object Object]">Bloom filter implementation</td></tr><tr><td class="border px-4 py-2" node="[object Object]"><code class="bg-muted rounded px-1.5 py-0.5 font-mono text-sm" node="[object Object]">src/hash_index.rs</code></td><td class="border px-4 py-2" node="[object Object]">Hash index with Bloom acceleration</td></tr><tr><td class="border px-4 py-2" node="[object Object]"><code class="bg-muted rounded px-1.5 py-0.5 font-mono text-sm" node="[object Object]">src/statistics.rs</code></td><td class="border px-4 py-2" node="[object Object]">Statistics collection and estimation</td></tr><tr><td class="border px-4 py-2" node="[object Object]"><code class="bg-muted rounded px-1.5 py-0.5 font-mono text-sm" node="[object Object]">src/ir/mod.rs</code></td><td class="border px-4 py-2" node="[object Object]">Intermediate Representation nodes</td></tr><tr><td class="border px-4 py-2" node="[object Object]"><code class="bg-muted rounded px-1.5 py-0.5 font-mono text-sm" node="[object Object]">src/join_planning/mod.rs</code></td><td class="border px-4 py-2" node="[object Object]">Join order optimization</td></tr><tr><td class="border px-4 py-2" node="[object Object]"><code class="bg-muted rounded px-1.5 py-0.5 font-mono text-sm" node="[object Object]">src/sip_rewriting/mod.rs</code></td><td class="border px-4 py-2" node="[object Object]">Sideways Information Passing</td></tr><tr><td class="border px-4 py-2" node="[object Object]"><code class="bg-muted rounded px-1.5 py-0.5 font-mono text-sm" node="[object Object]">src/subplan_sharing/mod.rs</code></td><td class="border px-4 py-2" node="[object Object]">Common subexpression elimination</td></tr></tbody></table></div>
<hr/>
<h2 id="14-architectural-patterns" node="[object Object]">14. Architectural Patterns</h2>
<h3 id="141-arc-wrapped-data-for-sharing" node="[object Object]">14.1 Arc-Wrapped Data for Sharing</h3>
<p>All persistent data wrapped in Arc for O(1) cloning:</p>
<pre class="rounded-lg bg-[var(--code-bg)] p-4 overflow-x-auto mb-4 text-sm font-mono" node="[object Object]"><code class="language-rust text-sm">input_tuples: <span class="syn-builtin">Arc</span>&lt;<span class="syn-builtin">HashMap</span>&lt;<span class="syn-builtin">String</span>, <span class="syn-builtin">Vec</span>&lt;Tuple&gt;&gt;&gt;
rules: <span class="syn-builtin">Arc</span>&lt;<span class="syn-builtin">Vec</span>&lt;Rule&gt;&gt;
materialized_relations: <span class="syn-builtin">Arc</span>&lt;<span class="syn-builtin">HashSet</span>&lt;<span class="syn-builtin">String</span>&gt;&gt;</code></pre>
<h3 id="142-arcswap-for-atomic-publishing" node="[object Object]">14.2 ArcSwap for Atomic Publishing</h3>
<pre class="rounded-lg bg-[var(--code-bg)] p-4 overflow-x-auto mb-4 text-sm font-mono" node="[object Object]"><code class="language-rust text-sm"><span class="syn-keyword">self</span>.snapshot.store(<span class="syn-builtin">Arc</span>::new(new_snapshot));  <span class="syn-comment">// O(1) atomic swap</span></code></pre>
<h3 id="143-fire-and-forget-shadow-writes" node="[object Object]">14.3 Fire-and-Forget Shadow Writes</h3>
<pre class="rounded-lg bg-[var(--code-bg)] p-4 overflow-x-auto mb-4 text-sm font-mono" node="[object Object]"><code class="language-rust text-sm">dd.insert(relation, tuples, time)?;  <span class="syn-comment">// Returns immediately</span>
<span class="syn-comment">// DD processes asynchronously</span></code></pre>
<h3 id="144-lazy-time-advancement" node="[object Object]">14.4 Lazy Time Advancement</h3>
<pre class="rounded-lg bg-[var(--code-bg)] p-4 overflow-x-auto mb-4 text-sm font-mono" node="[object Object]"><code class="language-rust text-sm">max_write_time.store(time, Ordering::Relaxed);  <span class="syn-comment">// Track writes</span>
<span class="syn-comment">// Only advance on read: max_write_time + 1</span></code></pre>
<h3 id="145-atomic-cascade-invalidation" node="[object Object]">14.5 Atomic Cascade Invalidation</h3>
<pre class="rounded-lg bg-[var(--code-bg)] p-4 overflow-x-auto mb-4 text-sm font-mono" node="[object Object]"><code class="language-rust text-sm"><span class="syn-comment">// Compute invalidation set (read-only)</span>
<span class="syn-keyword">let</span> to_invalidate = <span class="syn-keyword">self</span>.compute_invalidation_set(base_relation);

<span class="syn-comment">// Bump version</span>
*version += <span class="syn-number">1</span>;

<span class="syn-comment">// Apply all invalidations atomically</span>
<span class="syn-keyword">for</span> rel <span class="syn-keyword">in</span> <span class="syn-operator">&amp;</span>to_invalidate {
    mat.invalidate();
}</code></pre>
<h3 id="146-session-isolation-via-cloning" node="[object Object]">14.6 Session Isolation via Cloning</h3>
<pre class="rounded-lg bg-[var(--code-bg)] p-4 overflow-x-auto mb-4 text-sm font-mono" node="[object Object]"><code class="language-rust text-sm"><span class="syn-keyword">let</span> <span class="syn-keyword">mut</span> isolated = (*snapshot.input_tuples).clone();
isolated.insert(session_fact);
<span class="syn-comment">// Execute against isolated copy</span></code></pre>
<hr/>
<h2 id="15-summary" node="[object Object]">15. Summary</h2>
<p>InputLayer&#x27;s architecture provides:</p>
<div class="my-4 overflow-x-auto"><table class="w-full border-collapse" node="[object Object]"><thead><tr><th class="border px-4 py-2 text-left font-semibold bg-muted/50" node="[object Object]">Capability</th><th class="border px-4 py-2 text-left font-semibold bg-muted/50" node="[object Object]">Implementation</th></tr></thead><tbody><tr><td class="border px-4 py-2" node="[object Object]"><strong>Incremental computation</strong></td><td class="border px-4 py-2" node="[object Object]">DDComputation with persistent arrangements</td></tr><tr><td class="border px-4 py-2" node="[object Object]"><strong>Lock-free reads</strong></td><td class="border px-4 py-2" node="[object Object]">ArcSwap snapshot system</td></tr><tr><td class="border px-4 py-2" node="[object Object]"><strong>Concurrent writes</strong></td><td class="border px-4 py-2" node="[object Object]">DashMap + per-KG locking</td></tr><tr><td class="border px-4 py-2" node="[object Object]"><strong>Rule materialization</strong></td><td class="border px-4 py-2" node="[object Object]">DerivedRelationsManager with auto-rematerialization</td></tr><tr><td class="border px-4 py-2" node="[object Object]"><strong>Schema isolation</strong></td><td class="border px-4 py-2" node="[object Object]">Per-KG SchemaCatalog</td></tr><tr><td class="border px-4 py-2" node="[object Object]"><strong>Session isolation</strong></td><td class="border px-4 py-2" node="[object Object]">Cloned snapshots for ephemeral data</td></tr><tr><td class="border px-4 py-2" node="[object Object]"><strong>Parallel execution</strong></td><td class="border px-4 py-2" node="[object Object]">Rayon-based multi-worker batch queries</td></tr><tr><td class="border px-4 py-2" node="[object Object]"><strong>Durability</strong></td><td class="border px-4 py-2" node="[object Object]">WAL + Parquet batch files</td></tr><tr><td class="border px-4 py-2" node="[object Object]"><strong>Consistency</strong></td><td class="border px-4 py-2" node="[object Object]">Frontier tracking, atomic cascade invalidation</td></tr></tbody></table></div>
<p><strong>Test Coverage</strong>: ~3107 unit tests + ~1121 snapshot tests = ~4228 total, all passing.</p>
<p><strong>HNSW Readiness</strong>: All prerequisites complete. Indexes can attach as arrangement sinks.</p></article></div><div class="hidden lg:block w-48 shrink-0 border-l border-border/50"><div class="sticky top-0 p-4"><p class="text-xs font-semibold text-muted-foreground uppercase tracking-wider mb-3">On this page</p><nav class="space-y-1"><a href="#overview" class="block text-xs py-0.5 transition-colors hover:text-foreground text-muted-foreground">Overview</a><a href="#1-architecture-overview" class="block text-xs py-0.5 transition-colors hover:text-foreground text-muted-foreground">1. Architecture Overview</a><a href="#2-core-components" class="block text-xs py-0.5 transition-colors hover:text-foreground text-muted-foreground">2. Core Components</a><a href="#21-storageengine" class="block text-xs py-0.5 transition-colors hover:text-foreground pl-3 text-muted-foreground">2.1 StorageEngine</a><a href="#22-knowledgegraph" class="block text-xs py-0.5 transition-colors hover:text-foreground pl-3 text-muted-foreground">2.2 KnowledgeGraph</a><a href="#23-knowledgegraphsnapshot" class="block text-xs py-0.5 transition-colors hover:text-foreground pl-3 text-muted-foreground">2.3 KnowledgeGraphSnapshot</a><a href="#24-ddcomputation" class="block text-xs py-0.5 transition-colors hover:text-foreground pl-3 text-muted-foreground">2.4 DDComputation</a><a href="#25-derivedrelationsmanager" class="block text-xs py-0.5 transition-colors hover:text-foreground pl-3 text-muted-foreground">2.5 DerivedRelationsManager</a><a href="#3-data-flow-paths" class="block text-xs py-0.5 transition-colors hover:text-foreground text-muted-foreground">3. Data Flow Paths</a><a href="#31-write-path" class="block text-xs py-0.5 transition-colors hover:text-foreground pl-3 text-muted-foreground">3.1 Write Path</a><a href="#32-read-path-query" class="block text-xs py-0.5 transition-colors hover:text-foreground pl-3 text-muted-foreground">3.2 Read Path (Query)</a><a href="#33-materialization-flow" class="block text-xs py-0.5 transition-colors hover:text-foreground pl-3 text-muted-foreground">3.3 Materialization Flow</a><a href="#4-consistency-guarantees" class="block text-xs py-0.5 transition-colors hover:text-foreground text-muted-foreground">4. Consistency Guarantees</a><a href="#41-snapshot-consistency" class="block text-xs py-0.5 transition-colors hover:text-foreground pl-3 text-muted-foreground">4.1 Snapshot Consistency</a><a href="#42-write-consistency" class="block text-xs py-0.5 transition-colors hover:text-foreground pl-3 text-muted-foreground">4.2 Write Consistency</a><a href="#43-read-after-write-consistency" class="block text-xs py-0.5 transition-colors hover:text-foreground pl-3 text-muted-foreground">4.3 Read-After-Write Consistency</a><a href="#44-session-isolation" class="block text-xs py-0.5 transition-colors hover:text-foreground pl-3 text-muted-foreground">4.4 Session Isolation</a><a href="#5-rule-system" class="block text-xs py-0.5 transition-colors hover:text-foreground text-muted-foreground">5. Rule System</a><a href="#51-persistent-rules-prefix" class="block text-xs py-0.5 transition-colors hover:text-foreground pl-3 text-muted-foreground">5.1 Persistent Rules (+ prefix)</a><a href="#52-session-rules-no-prefix" class="block text-xs py-0.5 transition-colors hover:text-foreground pl-3 text-muted-foreground">5.2 Session Rules (no prefix)</a><a href="#53-rule-validation" class="block text-xs py-0.5 transition-colors hover:text-foreground pl-3 text-muted-foreground">5.3 Rule Validation</a><a href="#6-data-types" class="block text-xs py-0.5 transition-colors hover:text-foreground text-muted-foreground">6. Data Types</a><a href="#61-unified-tuple-format" class="block text-xs py-0.5 transition-colors hover:text-foreground pl-3 text-muted-foreground">6.1 Unified Tuple Format</a><a href="#62-abomonation-implementation" class="block text-xs py-0.5 transition-colors hover:text-foreground pl-3 text-muted-foreground">6.2 Abomonation Implementation</a><a href="#63-ast-display-implementations" class="block text-xs py-0.5 transition-colors hover:text-foreground pl-3 text-muted-foreground">6.3 AST Display Implementations</a><a href="#7-execution-model" class="block text-xs py-0.5 transition-colors hover:text-foreground text-muted-foreground">7. Execution Model</a><a href="#71-batch-execution-codegenerator" class="block text-xs py-0.5 transition-colors hover:text-foreground pl-3 text-muted-foreground">7.1 Batch Execution (CodeGenerator)</a><a href="#72-incremental-execution-ddcomputation" class="block text-xs py-0.5 transition-colors hover:text-foreground pl-3 text-muted-foreground">7.2 Incremental Execution (DDComputation)</a><a href="#8-persistence-layer" class="block text-xs py-0.5 transition-colors hover:text-foreground text-muted-foreground">8. Persistence Layer</a><a href="#81-wal-write-ahead-log" class="block text-xs py-0.5 transition-colors hover:text-foreground pl-3 text-muted-foreground">8.1 WAL (Write-Ahead Log)</a><a href="#82-batch-files-parquet" class="block text-xs py-0.5 transition-colors hover:text-foreground pl-3 text-muted-foreground">8.2 Batch Files (Parquet)</a><a href="#83-recovery-sequence" class="block text-xs py-0.5 transition-colors hover:text-foreground pl-3 text-muted-foreground">8.3 Recovery Sequence</a><a href="#9-protocol-layer" class="block text-xs py-0.5 transition-colors hover:text-foreground text-muted-foreground">9. Protocol Layer</a><a href="#91-handler" class="block text-xs py-0.5 transition-colors hover:text-foreground pl-3 text-muted-foreground">9.1 Handler</a><a href="#92-statement-types" class="block text-xs py-0.5 transition-colors hover:text-foreground pl-3 text-muted-foreground">9.2 Statement Types</a><a href="#10-hnsw-indexing-readiness" class="block text-xs py-0.5 transition-colors hover:text-foreground text-muted-foreground">10. HNSW Indexing Readiness</a><a href="#101-prerequisites-all-complete" class="block text-xs py-0.5 transition-colors hover:text-foreground pl-3 text-muted-foreground">10.1 Prerequisites (All Complete)</a><a href="#102-hnsw-integration-points" class="block text-xs py-0.5 transition-colors hover:text-foreground pl-3 text-muted-foreground">10.2 HNSW Integration Points</a><a href="#103-required-extensions-for-hnsw" class="block text-xs py-0.5 transition-colors hover:text-foreground pl-3 text-muted-foreground">10.3 Required Extensions for HNSW</a><a href="#11-configuration" class="block text-xs py-0.5 transition-colors hover:text-foreground text-muted-foreground">11. Configuration</a><a href="#111-performance-configuration" class="block text-xs py-0.5 transition-colors hover:text-foreground pl-3 text-muted-foreground">11.1 Performance Configuration</a><a href="#112-storage-configuration" class="block text-xs py-0.5 transition-colors hover:text-foreground pl-3 text-muted-foreground">11.2 Storage Configuration</a><a href="#113-environment-variables" class="block text-xs py-0.5 transition-colors hover:text-foreground pl-3 text-muted-foreground">11.3 Environment Variables</a><a href="#12-query-optimization" class="block text-xs py-0.5 transition-colors hover:text-foreground text-muted-foreground">12. Query Optimization</a><a href="#121-optimization-modules" class="block text-xs py-0.5 transition-colors hover:text-foreground pl-3 text-muted-foreground">12.1 Optimization Modules</a><a href="#122-bloom-filter" class="block text-xs py-0.5 transition-colors hover:text-foreground pl-3 text-muted-foreground">12.2 Bloom Filter</a><a href="#123-hash-index" class="block text-xs py-0.5 transition-colors hover:text-foreground pl-3 text-muted-foreground">12.3 Hash Index</a><a href="#124-statistics-manager" class="block text-xs py-0.5 transition-colors hover:text-foreground pl-3 text-muted-foreground">12.4 Statistics Manager</a><a href="#125-bloomsemijoin-ir-node" class="block text-xs py-0.5 transition-colors hover:text-foreground pl-3 text-muted-foreground">12.5 BloomSemijoin IR Node</a><a href="#13-file-reference" class="block text-xs py-0.5 transition-colors hover:text-foreground text-muted-foreground">13. File Reference</a><a href="#14-architectural-patterns" class="block text-xs py-0.5 transition-colors hover:text-foreground text-muted-foreground">14. Architectural Patterns</a><a href="#141-arc-wrapped-data-for-sharing" class="block text-xs py-0.5 transition-colors hover:text-foreground pl-3 text-muted-foreground">14.1 Arc-Wrapped Data for Sharing</a><a href="#142-arcswap-for-atomic-publishing" class="block text-xs py-0.5 transition-colors hover:text-foreground pl-3 text-muted-foreground">14.2 ArcSwap for Atomic Publishing</a><a href="#143-fire-and-forget-shadow-writes" class="block text-xs py-0.5 transition-colors hover:text-foreground pl-3 text-muted-foreground">14.3 Fire-and-Forget Shadow Writes</a><a href="#144-lazy-time-advancement" class="block text-xs py-0.5 transition-colors hover:text-foreground pl-3 text-muted-foreground">14.4 Lazy Time Advancement</a><a href="#145-atomic-cascade-invalidation" class="block text-xs py-0.5 transition-colors hover:text-foreground pl-3 text-muted-foreground">14.5 Atomic Cascade Invalidation</a><a href="#146-session-isolation-via-cloning" class="block text-xs py-0.5 transition-colors hover:text-foreground pl-3 text-muted-foreground">14.6 Session Isolation via Cloning</a><a href="#15-summary" class="block text-xs py-0.5 transition-colors hover:text-foreground text-muted-foreground">15. Summary</a></nav></div></div></div></div></div></div><!--$--><!--/$--><script src="/_next/static/chunks/webpack-bd6546b43ab2ecbf.js" id="_R_" async=""></script><script>(self.__next_f=self.__next_f||[]).push([0])</script><script>self.__next_f.push([1,"1:\"$Sreact.fragment\"\n2:I[1942,[\"177\",\"static/chunks/app/layout-7e9963bf811be36b.js\"],\"ThemeProvider\"]\n3:I[7121,[],\"\"]\n4:I[4581,[],\"\"]\n6:I[484,[],\"OutletBoundary\"]\n7:\"$Sreact.suspense\"\n9:I[484,[],\"ViewportBoundary\"]\nb:I[484,[],\"MetadataBoundary\"]\nd:I[7123,[],\"\"]\n:HL[\"/_next/static/media/4cf2300e9c8272f7-s.p.woff2\",\"font\",{\"crossOrigin\":\"\",\"type\":\"font/woff2\"}]\n:HL[\"/_next/static/media/93f479601ee12b01-s.p.woff2\",\"font\",{\"crossOrigin\":\"\",\"type\":\"font/woff2\"}]\n:HL[\"/_next/static/css/4bd7a24b7976d4e6.css\",\"style\"]\n"])</script><script>self.__next_f.push([1,"0:{\"P\":null,\"b\":\"05bjYGyiAumoEMBrfWHih\",\"c\":[\"\",\"docs\",\"internals\",\"architecture\",\"\"],\"q\":\"\",\"i\":false,\"f\":[[[\"\",{\"children\":[\"docs\",{\"children\":[[\"slug\",\"internals/architecture\",\"oc\"],{\"children\":[\"__PAGE__\",{}]}]}]},\"$undefined\",\"$undefined\",true],[[\"$\",\"$1\",\"c\",{\"children\":[[[\"$\",\"link\",\"0\",{\"rel\":\"stylesheet\",\"href\":\"/_next/static/css/4bd7a24b7976d4e6.css\",\"precedence\":\"next\",\"crossOrigin\":\"$undefined\",\"nonce\":\"$undefined\"}]],[\"$\",\"html\",null,{\"lang\":\"en\",\"suppressHydrationWarning\":true,\"children\":[\"$\",\"body\",null,{\"className\":\"__variable_188709 __variable_9a8899 font-sans antialiased\",\"children\":[\"$\",\"$L2\",null,{\"attribute\":\"class\",\"defaultTheme\":\"dark\",\"enableSystem\":true,\"disableTransitionOnChange\":true,\"children\":[\"$\",\"$L3\",null,{\"parallelRouterKey\":\"children\",\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"errorScripts\":\"$undefined\",\"template\":[\"$\",\"$L4\",null,{}],\"templateStyles\":\"$undefined\",\"templateScripts\":\"$undefined\",\"notFound\":[[[\"$\",\"title\",null,{\"children\":\"404: This page could not be found.\"}],[\"$\",\"div\",null,{\"style\":{\"fontFamily\":\"system-ui,\\\"Segoe UI\\\",Roboto,Helvetica,Arial,sans-serif,\\\"Apple Color Emoji\\\",\\\"Segoe UI Emoji\\\"\",\"height\":\"100vh\",\"textAlign\":\"center\",\"display\":\"flex\",\"flexDirection\":\"column\",\"alignItems\":\"center\",\"justifyContent\":\"center\"},\"children\":[\"$\",\"div\",null,{\"children\":[[\"$\",\"style\",null,{\"dangerouslySetInnerHTML\":{\"__html\":\"body{color:#000;background:#fff;margin:0}.next-error-h1{border-right:1px solid rgba(0,0,0,.3)}@media (prefers-color-scheme:dark){body{color:#fff;background:#000}.next-error-h1{border-right:1px solid rgba(255,255,255,.3)}}\"}}],[\"$\",\"h1\",null,{\"className\":\"next-error-h1\",\"style\":{\"display\":\"inline-block\",\"margin\":\"0 20px 0 0\",\"padding\":\"0 23px 0 0\",\"fontSize\":24,\"fontWeight\":500,\"verticalAlign\":\"top\",\"lineHeight\":\"49px\"},\"children\":404}],[\"$\",\"div\",null,{\"style\":{\"display\":\"inline-block\"},\"children\":[\"$\",\"h2\",null,{\"style\":{\"fontSize\":14,\"fontWeight\":400,\"lineHeight\":\"49px\",\"margin\":0},\"children\":\"This page could not be found.\"}]}]]}]}]],[]],\"forbidden\":\"$undefined\",\"unauthorized\":\"$undefined\"}]}]}]}]]}],{\"children\":[[\"$\",\"$1\",\"c\",{\"children\":[null,[\"$\",\"$L3\",null,{\"parallelRouterKey\":\"children\",\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"errorScripts\":\"$undefined\",\"template\":[\"$\",\"$L4\",null,{}],\"templateStyles\":\"$undefined\",\"templateScripts\":\"$undefined\",\"notFound\":\"$undefined\",\"forbidden\":\"$undefined\",\"unauthorized\":\"$undefined\"}]]}],{\"children\":[[\"$\",\"$1\",\"c\",{\"children\":[null,[\"$\",\"$L3\",null,{\"parallelRouterKey\":\"children\",\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"errorScripts\":\"$undefined\",\"template\":[\"$\",\"$L4\",null,{}],\"templateStyles\":\"$undefined\",\"templateScripts\":\"$undefined\",\"notFound\":\"$undefined\",\"forbidden\":\"$undefined\",\"unauthorized\":\"$undefined\"}]]}],{\"children\":[[\"$\",\"$1\",\"c\",{\"children\":[\"$L5\",null,[\"$\",\"$L6\",null,{\"children\":[\"$\",\"$7\",null,{\"name\":\"Next.MetadataOutlet\",\"children\":\"$@8\"}]}]]}],{},null,false,false]},null,false,false]},null,false,false]},null,false,false],[\"$\",\"$1\",\"h\",{\"children\":[null,[\"$\",\"$L9\",null,{\"children\":\"$@a\"}],[\"$\",\"div\",null,{\"hidden\":true,\"children\":[\"$\",\"$Lb\",null,{\"children\":[\"$\",\"$7\",null,{\"name\":\"Next.Metadata\",\"children\":\"$@c\"}]}]}],[\"$\",\"meta\",null,{\"name\":\"next-size-adjust\",\"content\":\"\"}]]}],false]],\"m\":\"$undefined\",\"G\":[\"$d\",[]],\"S\":true}\n"])</script><script>self.__next_f.push([1,"e:I[8428,[\"758\",\"static/chunks/758-3cb69ce377cde046.js\",\"121\",\"static/chunks/121-aece4f809b101dc1.js\",\"502\",\"static/chunks/502-e809071f8789437b.js\",\"689\",\"static/chunks/689-4fcf9680fdc90283.js\",\"870\",\"static/chunks/app/docs/%5B%5B...slug%5D%5D/page-004ec69e3c86920a.js\"],\"DocsPageClient\"]\nf:T6221,"])</script><script>self.__next_f.push([1,"# InputLayer Architecture\n\n**Version**: 3.0 (Production-Ready)\n**Date**: 2026-02-05\n**Status**: All architectural issues resolved, ready for HNSW indexing\n\n---\n\n## Overview\n\nInputLayer is an incremental database engine built on Differential Dataflow (DD). The architecture supports:\n\n- **Persistent incremental computation** via DDComputation with shared arrangements\n- **Lock-free concurrent reads** via ArcSwap snapshot system\n- **Rule materialization** with automatic cascade invalidation\n- **Session isolation** for ephemeral facts and rules\n- **Multi-worker parallel execution** for batch queries\n\n**Test Coverage**: ~3107 unit tests + ~1121 snapshot tests = ~4228 total, all passing.\n\n---\n\n## 1. Architecture Overview\n\n```\n+-----------------------------------------------------------------------------+\n|                              StorageEngine                                    |\n|                    DashMap\u003cString, Arc\u003cRwLock\u003cKnowledgeGraph\u003e\u003e\u003e              |\n|                                                                               |\n|  +-------------------------------------------------------------------------+ |\n|  |                        KnowledgeGraph                                    | |\n|  |                                                                          | |\n|  |  +--------------------+  +--------------------+  +-------------------+  | |\n|  |  |   DatalogEngine    |  |    RuleCatalog     |  |  DDComputation    |  | |\n|  |  |                    |  |                    |  |   (Optional)      |  | |\n|  |  | input_tuples:      |  | rules: HashMap     |  |                   |  | |\n|  |  |   HashMap\u003cString,  |  | catalog.json       |  | InputSessions     |  | |\n|  |  |   Vec\u003cTuple\u003e\u003e      |  |                    |  | TraceAgents       |  | |\n|  |  |                    |  | Stratification     |  | Arrangements      |  | |\n|  |  | num_workers: usize |  | Validation         |  | ProbeHandle\u003cu64\u003e  |  | |\n|  |  +--------------------+  +--------------------+  |                   |  | |\n|  |                                                   | DerivedRelations |  | |\n|  |  +--------------------------------------------+  |   Manager        |  | |\n|  |  |        ArcSwap\u003cKnowledgeGraphSnapshot\u003e      |  +-------------------+  | |\n|  |  |                                             |                          | |\n|  |  |  input_tuples: Arc\u003cHashMap\u003e                |                          | |\n|  |  |  rules: Arc\u003cVec\u003cRule\u003e\u003e                     |                          | |\n|  |  |  materialized_relations: Arc\u003cHashSet\u003e      |                          | |\n|  |  |  num_workers: usize                        |                          | |\n|  |  +--------------------------------------------+                          | |\n|  +-------------------------------------------------------------------------+ |\n|                                                                               |\n|  +-------------------------------------------------------------------------+ |\n|  |                          FilePersist                                     | |\n|  |              WAL (Write-Ahead Log) + Parquet Batch Files                | |\n|  +-------------------------------------------------------------------------+ |\n+-----------------------------------------------------------------------------+\n```\n\n---\n\n## 2. Core Components\n\n### 2.1 StorageEngine\n\n**Purpose**: Multi-knowledge-graph storage with concurrent access.\n\n```rust\npub struct StorageEngine {\n    knowledge_graphs: DashMap\u003cString, Arc\u003cRwLock\u003cKnowledgeGraph\u003e\u003e\u003e,\n    logical_time: AtomicU64,\n    persist: Arc\u003cFilePersist\u003e,\n    config: StorageConfig,\n}\n```\n\n**Key Features**:\n- **DashMap** enables concurrent access to different KGs without global locking\n- **Logical timestamps** provide monotonically increasing write ordering\n- **Per-KG locking** allows parallel queries to different knowledge graphs\n\n### 2.2 KnowledgeGraph\n\n**Purpose**: Single knowledge graph with data, rules, and optional incremental computation.\n\n```rust\npub struct KnowledgeGraph {\n    name: String,\n    engine: DatalogEngine,\n    rule_catalog: RuleCatalog,\n    schema_catalog: SchemaCatalog,  // Per-KG schema isolation\n    snapshot: ArcSwap\u003cKnowledgeGraphSnapshot\u003e,\n    dd_computation: Option\u003cDDComputation\u003e,\n    num_workers: usize,\n}\n```\n\n**Key Features**:\n- **DatalogEngine**: Holds base relation data (`input_tuples`, private with accessors)\n- **RuleCatalog**: Persistent rule storage with stratification validation\n- **SchemaCatalog**: Per-KG schema validation (isolated from other KGs)\n- **Snapshot**: Lock-free point-in-time consistent views via ArcSwap\n- **DDComputation**: Optional persistent incremental computation (returns `Result`)\n\n### 2.3 KnowledgeGraphSnapshot\n\n**Purpose**: Immutable point-in-time view for lock-free reads.\n\n```rust\npub struct KnowledgeGraphSnapshot {\n    version: u64,\n    timestamp: u64,\n    input_tuples: Arc\u003cHashMap\u003cString, Vec\u003cTuple\u003e\u003e\u003e,\n    rules: Arc\u003cVec\u003cRule\u003e\u003e,\n    materialized_relations: Arc\u003cHashSet\u003cString\u003e\u003e,\n    num_workers: usize,\n}\n```\n\n**Key Features**:\n- **Arc-wrapped data** enables O(1) clone operations\n- **ArcSwap** provides atomic snapshot publication\n- **Materialization awareness** skips rules for already-materialized relations\n- **Session isolation** via `execute_with_session_facts()` method\n\n### 2.4 DDComputation\n\n**Purpose**: Persistent incremental computation with shared arrangements.\n\n```rust\npub struct DDComputation {\n    command_tx: Sender\u003cDDCommand\u003e,\n    current_time: Arc\u003cAtomicU64\u003e,\n    max_write_time: Arc\u003cAtomicU64\u003e,\n    derived_relations: Arc\u003cMutex\u003cDerivedRelationsManager\u003e\u003e,\n    known_relations: Mutex\u003cHashSet\u003cString\u003e\u003e,\n    worker_handle: Option\u003cJoinHandle\u003c()\u003e\u003e,\n}\n```\n\n**Architecture**:\n```\nMain Thread --command_tx--\u003e DD Worker Thread\n                            +- Owns timely Worker\u003cu64\u003e\n                            +- Owns InputSessions per relation\n                            +- Owns TraceAgents (arrangements)\n                            +- Steps worker in event loop\n                            +- Processes commands between steps\n```\n\n**Command Protocol**:\n```rust\nenum DDCommand {\n    InsertDelta { relation, updates: Vec\u003c(Tuple, u64, isize)\u003e },\n    AdvanceTime(u64),\n    WaitUntilCaughtUp(u64, oneshot::Sender\u003c()\u003e),\n    AddRelation(String),\n    RegisterRule { name, dependencies },\n    RemoveRule(String),\n    SetMaterialized { relation, tuples },\n    NotifyBaseUpdate(String),\n    ReadRelation(String, oneshot::Sender\u003cVec\u003cTuple\u003e\u003e),\n    Shutdown,\n}\n```\n\n### 2.5 DerivedRelationsManager\n\n**Purpose**: Manage materialized derived relations with validity tracking.\n\n```rust\npub struct DerivedRelationsManager {\n    compiled_rules: HashMap\u003cString, CompiledRule\u003e,\n    materialized: HashMap\u003cString, MaterializedRelation\u003e,\n    base_to_derived: HashMap\u003cString, HashSet\u003cString\u003e\u003e,\n    derived_to_derived: HashMap\u003cString, HashSet\u003cString\u003e\u003e,\n    base_versions: HashMap\u003cString, u64\u003e,\n}\n\npub struct MaterializedRelation {\n    tuples: Vec\u003cTuple\u003e,\n    version: u64,\n    base_versions: HashMap\u003cString, u64\u003e,\n    valid: bool,\n    materialized_at: u64,\n}\n```\n\n**Key Features**:\n- **Dependency tracking** maps base relations to derived relations\n- **Cascade invalidation** automatically invalidates dependent materializations\n- **Validity tracking** ensures queries see consistent data\n- **Version management** for optimistic concurrency\n\n---\n\n## 3. Data Flow Paths\n\n### 3.1 Write Path\n\n```\nInsert Request\n    |\n    v\nFilePersist.append() --------------------------\u003e Durability (WAL)\n    |\n    v\nKnowledgeGraph.insert_in_memory()\n    |\n    +-\u003e engine.input_tuples.insert() -----------\u003e In-memory state\n    |\n    +-\u003e DDComputation.insert() (if enabled)\n        |\n        +-\u003e InputSession.update(tuple, time, +1)\n        |\n        +-\u003e notify_base_update() ---------------\u003e Cascade invalidation\n            |\n            +-\u003e Invalidate dependent materializations\n    |\n    v\nauto_rematerialize_invalid_rules() -------------\u003e Recompute materializations\n    |\n    v\npublish_snapshot() -----------------------------\u003e Atomic snapshot publication\n    |\n    +-\u003e Merge valid materializations into input_tuples\n    |\n    +-\u003e ArcSwap.store(new_snapshot)\n```\n\n### 3.2 Read Path (Query)\n\n```\nQuery Request\n    |\n    v\nHandler.query_program()\n    |\n    +-\u003e Validate session rules -----------------\u003e validate_rule()\n    |\n    +-\u003e Parse statements\n    |\n    +-\u003e Collect session facts and rules\n    |\n    v\nStorageEngine.execute_query_with_session_facts_on()\n    |\n    v\nKnowledgeGraphSnapshot.execute_with_session_facts()\n    |\n    +-\u003e Clone input_tuples (isolated copy)\n    |\n    +-\u003e Add session facts to clone\n    |\n    +-\u003e Build combined program:\n    |   +-\u003e Persistent rules (skip if materialized)\n    |   +-\u003e Session rules\n    |   +-\u003e Query\n    |\n    +-\u003e DatalogEngine.execute_tuples()\n        |\n        +-\u003e CodeGenerator with num_workers config\n    |\n    v\nResults (concurrent queries unaffected)\n```\n\n### 3.3 Materialization Flow\n\n```\nRule Registration\n    |\n    v\nRuleCatalog.register_rule()\n    |\n    +-\u003e Stratification validation\n    |\n    +-\u003e DDComputation.register_rule()\n        |\n        +-\u003e DerivedRelationsManager.register_rule()\n    |\n    v\nauto_materialize_rule()\n    |\n    +-\u003e Execute rule against current data\n    |\n    +-\u003e DDComputation.set_materialized()\n    |\n    v\npublish_snapshot()\n    |\n    +-\u003e Merge materialized tuples into snapshot\n    |\n    +-\u003e Record materialized_relations set\n```\n\n---\n\n## 4. Consistency Guarantees\n\n### 4.1 Snapshot Consistency\n\n**Guarantee**: Point-in-time consistent views via immutable Arc-wrapped data.\n\n- Readers get consistent snapshots without holding locks\n- Snapshot cloning is O(1) due to Arc sharing\n- Session facts isolation via cloned HashMap\n- No TOCTOU vulnerabilities (lock held through publication)\n\n### 4.2 Write Consistency\n\n**Guarantee**: All writes are durable before acknowledgment.\n\n- WAL append before in-memory update\n- DD shadow writes propagate with proper timestamps\n- Cascade invalidation is atomic (compute-then-apply pattern)\n\n### 4.3 Read-After-Write Consistency\n\n**Guarantee**: Via `read_relation_consistent()` in DDComputation.\n\n```rust\npub fn read_relation_consistent(\u0026self, relation: \u0026str) -\u003e Result\u003cVec\u003cTuple\u003e\u003e {\n    // 1. Advance time to max_write_time + 1\n    // 2. Wait for DD frontier to pass\n    // 3. Read from arrangement cursor\n}\n```\n\n### 4.4 Session Isolation\n\n**Guarantee**: Session facts and rules don't affect concurrent queries.\n\n```rust\npub fn execute_with_session_facts(\n    \u0026self,\n    program: \u0026str,\n    session_facts: Vec\u003c(String, Tuple)\u003e,\n) -\u003e Result\u003cVec\u003cTuple\u003e\u003e {\n    // Clone input_tuples (isolated copy)\n    let mut isolated = (*self.input_tuples).clone();\n\n    // Add session facts to the clone\n    for (relation, tuple) in session_facts {\n        isolated.entry(relation).or_default().push(tuple);\n    }\n\n    // Execute against isolated state\n    // ...\n}\n```\n\n---\n\n## 5. Rule System\n\n### 5.1 Persistent Rules (`+` prefix)\n\n```datalog\n+path(X, Y) \u003c- edge(X, Y)\n+path(X, Z) \u003c- path(X, Y), edge(Y, Z)\n```\n\n**Characteristics**:\n- Stored in RuleCatalog (JSON persistence)\n- Registered with DDComputation for dependency tracking\n- Auto-materialized on registration and base data changes\n- Cascade invalidation when dependencies change\n\n### 5.2 Session Rules (no prefix)\n\n```datalog\nreachable_from(Y) \u003c- path(1, Y)\n?reachable_from(X)\n```\n\n**Characteristics**:\n- Ephemeral (per-request lifecycle)\n- Validated for stratification before execution\n- Can reference materialized persistent rules\n- Computed fresh each time (not cached)\n\n### 5.3 Rule Validation\n\n```rust\n/// Validate single rule (self-negation, head safety, range restriction)\npub fn validate_rule(rule: \u0026Rule, name: \u0026str) -\u003e Result\u003c(), String\u003e;\n\n/// Validate rule set for stratification (negation cycles)\npub fn validate_rules_stratification(rules: \u0026[Rule]) -\u003e Result\u003c(), String\u003e;\n```\n\n**Checks**:\n- **Self-negation**: Can't negate own head\n- **Head variable safety**: All head variables must be bound by positive atoms\n- **Range restriction**: Variables in negated atoms must be bound by positive atoms\n- **Stratification**: No mutual negation cycles\n\n---\n\n## 6. Data Types\n\n### 6.1 Unified Tuple Format\n\n```rust\npub struct Tuple(pub Vec\u003cValue\u003e);\n\npub enum Value {\n    Null,\n    Bool(bool),\n    Int(i64),\n    Float(f64),\n    String(Arc\u003cString\u003e),\n    Vector(Arc\u003cVec\u003cf32\u003e\u003e),\n    VectorInt8(Arc\u003cVec\u003ci8\u003e\u003e),\n}\n```\n\n**Key Features**:\n- **Single format** throughout the system (Tuple2 removed)\n- **Arbitrary arity** tuples\n- **Vector support** for similarity search\n- **Abomonation** implemented for multi-worker DD\n\n### 6.2 Abomonation Implementation\n\n```rust\n// Proper entomb/exhume for multi-worker DD communication\nunsafe impl Abomonation for Value {\n    unsafe fn entomb\u003cW: Write\u003e(\u0026self, write: \u0026mut W) -\u003e IoResult\u003c()\u003e {\n        // Write tag + data in custom format\n    }\n\n    unsafe fn exhume\u003c'b\u003e(\u0026mut self, bytes: \u0026'b mut [u8]) -\u003e Option\u003c\u0026'b mut [u8]\u003e {\n        // Reconstruct Value from bytes with proper Arc allocations\n    }\n}\n```\n\n### 6.3 AST Display Implementations\n\nAll AST types implement `Display` for consistent Datalog text formatting:\n\n```rust\nimpl Display for Term { ... }      // Variables, constants, aggregates, etc.\nimpl Display for Atom { ... }      // relation(arg1, arg2, ...)\nimpl Display for BodyPredicate { ... }  // Positive, negated, comparison\nimpl Display for Rule { ... }      // head \u003c- body\nimpl Display for ArithExpr { ... } // Arithmetic expressions\nimpl Display for AggregateFunc { ... }  // count, sum, top_k\u003c...\u003e, etc.\nimpl Display for ComparisonOp { ... }   // =, !=, \u003c, \u003c=, \u003e, \u003e=\n```\n\n**Usage**: All components use `term.to_string()` instead of duplicate formatting functions.\n\n---\n\n## 7. Execution Model\n\n### 7.1 Batch Execution (CodeGenerator)\n\n```rust\npub struct CodeGenerator {\n    input_data: HashMap\u003cString, Vec\u003cTuple\u003e\u003e,\n}\n\npub struct ExecutionConfig {\n    num_workers: usize,\n}\n```\n\n**Execution Paths**:\n1. **Non-recursive**: Single `execute_directly` call\n2. **Transitive closure**: DD iterative scope with `SemigroupVariable`\n3. **General recursive**: DD `.iterative()` scope with live collections\n\n**Parallelization**:\n- Rayon-based parallel execution for scan/filter/map\n- Join queries use single-worker DD for correctness\n- Configurable via `num_workers`\n\n### 7.2 Incremental Execution (DDComputation)\n\n```rust\nimpl DDComputation {\n    // Returns Result - no more panicking on initialization errors\n    pub fn new(relations: Vec\u003cString\u003e) -\u003e Result\u003cSelf, String\u003e;\n\n    pub fn insert(\u0026self, relation: \u0026str, tuples: Vec\u003cTuple\u003e, time: u64) -\u003e Result\u003c()\u003e;\n    pub fn delete(\u0026self, relation: \u0026str, tuples: Vec\u003cTuple\u003e, time: u64) -\u003e Result\u003c()\u003e;\n    pub fn read_relation_consistent(\u0026self, relation: \u0026str) -\u003e Result\u003cVec\u003cTuple\u003e\u003e;\n}\n```\n\n**Features**:\n- **Fire-and-forget inserts**: Shadow writes don't block query execution\n- **Lazy time advancement**: Writes buffer, time only advances on consistent reads\n- **Dynamic relations**: InputSessions created at runtime\n\n---\n\n## 8. Persistence Layer\n\n### 8.1 WAL (Write-Ahead Log)\n\n```rust\npub struct Update {\n    pub data: Tuple,\n    pub time: u64,\n    pub diff: i64,  // +1 for insert, -1 for delete\n}\n\npub struct WalEntry {\n    pub shard: String,\n    pub update: Update,\n}\n```\n\n### 8.2 Batch Files (Parquet)\n\n```rust\npub struct ShardMeta {\n    pub shard: String,\n    pub batches: Vec\u003cBatchMeta\u003e,\n    pub since: u64,   // Compaction frontier\n    pub upper: u64,   // Write frontier\n}\n```\n\n### 8.3 Recovery Sequence\n\n```\n1. Load shard metadata from disk\n2. Create DDComputation for each KG\n3. Replay batch files through InputSessions\n4. Replay WAL entries since last batch\n5. Step workers until frontier advances past WAL upper\n6. DDComputation is live and ready\n```\n\n---\n\n## 9. Protocol Layer\n\n### 9.1 Handler\n\n```rust\npub struct Handler {\n    storage: Arc\u003cRwLock\u003cStorageEngine\u003e\u003e,\n    start_time: Instant,\n    query_count: AtomicU64,\n    insert_count: AtomicU64,\n}\n```\n\n**Key Features**:\n- **Read lock** for all query operations (concurrent queries)\n- **Explicit KG naming** via `_on()`, `_into()`, `_from()` variants\n- **Session fact isolation** via `execute_query_with_session_facts_on()`\n- **Per-KG schema validation** delegated to StorageEngine (schemas isolated per KG)\n\n### 9.2 Statement Types\n\n```rust\npub enum Statement {\n    SchemaDecl(SchemaDecl),\n    PersistentRule(Rule),      // +name(...) \u003c- body\n    SessionRule(Rule),          // name(...) \u003c- body\n    PersistentFact(Fact),      // +relation(values)\n    SessionFact(Fact),          // relation(values)\n    Query(Query),               // ?body\n    ConditionalDelete(Rule),   // -relation(X) \u003c- condition\n    DotCommand(DotCommand),    // .kg, .rule, .rel, etc.\n}\n```\n\n---\n\n## 10. HNSW Indexing Readiness\n\n### 10.1 Prerequisites (All Complete)\n\n| Prerequisite | Status | Description |\n|-------------|--------|-------------|\n| Abomonation fix | Done | Proper exhume() for multi-worker DD |\n| Generic timestamps | Done | CodeGenerator uses `G::Timestamp: Lattice + Ord + Default` |\n| DDComputation | Done | Persistent incremental computation |\n| Insert path wiring | Done | Shadow writes to DDComputation |\n| Consistent reads | Done | Lazy time advancement + frontier tracking |\n| Rule materialization | Done | DerivedRelationsManager with validity tracking |\n| Auto-materialization | Done | Persistent rules auto-materialize |\n| Session isolation | Done | Cloned snapshots for session facts |\n\n### 10.2 HNSW Integration Points\n\n```\nInsert -\u003e Persist WAL -\u003e In-Memory State -\u003e DDComputation\n                                              |\n                                              v\n                                        Arrangement\n                                              |\n                                              v\n                                    [HNSW INDEX SINK]\n                                              |\n                                    On insert: hnsw.insert(embedding, id)\n                                    On delete: tombstone.add(id)\n```\n\n### 10.3 Required Extensions for HNSW\n\n1. **IndexManager** in KnowledgeGraph\n2. **IRNode::IndexScan** in IR\n3. **`.index create/drop/rebuild`** commands\n4. **Query planning** for distance predicates\n\n---\n\n## 11. Configuration\n\n### 11.1 Performance Configuration\n\n```toml\n[storage.performance]\nnum_threads = 4       # Workers for parallel execution\nbatch_size = 1000     # Batch size for operations\n```\n\n### 11.2 Storage Configuration\n\n```toml\n[storage]\ndata_dir = \"./data\"\nauto_create_kg = true\ndefault_kg = \"default\"\n```\n\n### 11.3 Environment Variables\n\nAll environment variables use the `IL_` prefix:\n\n| Variable | Purpose |\n|----------|---------|\n| `IL_DEBUG` | Enable debug output for IR building, execution, and optimization |\n| `IL_DEBUG_SESSION` | Enable debug output for session fact handling |\n\n---\n\n## 12. Query Optimization\n\nInputLayer includes query optimization infrastructure for improving join performance.\n\n### 12.1 Optimization Modules\n\n| Module | File | Purpose |\n|--------|------|---------|\n| **Bloom Filter** | `src/bloom_filter.rs` | Probabilistic set membership testing |\n| **Hash Index** | `src/hash_index.rs` | O(1) join key lookups with Bloom acceleration |\n| **Statistics** | `src/statistics.rs` | Cardinality and selectivity estimation |\n| **Join Planning** | `src/join_planning/mod.rs` | Join ordering via MST algorithm |\n| **SIP Rewriting** | `src/sip_rewriting/mod.rs` | Sideways Information Passing |\n| **Subplan Sharing** | `src/subplan_sharing/mod.rs` | Common subexpression elimination |\n\n### 12.2 Bloom Filter\n\nSpace-efficient probabilistic data structure for fast set membership testing.\n\n```rust\nuse inputlayer::bloom_filter::{BloomFilter, BloomFilterBuilder};\n\n// Create filter for 10K elements with 1% false positive rate\nlet mut filter = BloomFilter::new(10_000, 0.01);\nfilter.insert(\u0026\"key1\");\nfilter.insert(\u0026\"key2\");\n\n// Check membership (no false negatives, possible false positives)\nif filter.might_contain(\u0026\"key1\") {\n    // Definitely present or false positive\n}\n```\n\n**Properties:**\n- No false negatives: if `might_contain()` returns `false`, the element is definitely not present\n- Possible false positives: if `might_contain()` returns `true`, element might or might not be present\n- Space efficient: ~10 bits per element for 1% false positive rate\n\n### 12.3 Hash Index\n\nAccelerates join key lookups with Bloom filter pre-filtering.\n\n```rust\nuse inputlayer::hash_index::{HashIndex, HashIndexManager, JoinKeySpec};\n\n// Create index for edge(src, dst) on column 0\nlet spec = JoinKeySpec::new(\"edge\", vec![0]);\nlet mut index = HashIndex::new(spec);\n\n// Build from tuples\nindex.build_from_tuples(\u0026edge_tuples);\n\n// Lookup with Bloom filter check first\nif let Some(matching) = index.lookup(\u0026key) {\n    for tuple in matching {\n        // Process matching tuples\n    }\n}\n```\n\n### 12.4 Statistics Manager\n\nCollects and maintains relation statistics for query optimization.\n\n```rust\nuse inputlayer::statistics::{StatisticsManager, RelationStats};\n\nlet mut stats_manager = StatisticsManager::new();\n\n// Update statistics for a relation\nstats_manager.update_stats(\"edge\", \u0026edge_tuples);\n\n// Get cardinality estimate\nif let Some(stats) = stats_manager.get_stats(\"edge\") {\n    println!(\"Cardinality: {}\", stats.cardinality);\n    println!(\"Distinct values in col 0: {}\", stats.column_stats[0].distinct_count);\n}\n\n// Estimate join selectivity\nlet selectivity = stats_manager.estimate_join_selectivity(\"edge\", 0, \"node\", 0);\n```\n\n### 12.5 BloomSemijoin IR Node\n\nThe IR includes a `BloomSemijoin` node for semijoin reduction:\n\n```rust\nIRNode::BloomSemijoin {\n    input: Box\u003cIRNode\u003e,           // Relation to filter\n    filter_source: Box\u003cIRNode\u003e,   // Relation providing filter keys\n    input_key_columns: Vec\u003cusize\u003e,\n    filter_key_columns: Vec\u003cusize\u003e,\n    output_schema: Vec\u003cString\u003e,\n}\n```\n\nThis node filters `input` to keep only tuples whose key columns exist in `filter_source`, implemented via Differential Dataflow's `semijoin()` operator.\n\n---\n\n## 13. File Reference\n\n| File | Purpose |\n|------|---------|\n| `src/lib.rs` | DatalogEngine, public API |\n| `src/ast/mod.rs` | AST types with Display implementations |\n| `src/value/mod.rs` | Value, Tuple, Abomonation |\n| `src/storage_engine/mod.rs` | StorageEngine, KnowledgeGraph |\n| `src/storage_engine/snapshot.rs` | KnowledgeGraphSnapshot |\n| `src/incremental.rs` | IncrementalEngine |\n| `src/derived_relations.rs` | DerivedRelationsManager |\n| `src/rule_catalog.rs` | RuleCatalog, validation |\n| `src/schema/catalog.rs` | SchemaCatalog (per-KG) |\n| `src/code_generator/mod.rs` | CodeGenerator, execution |\n| `src/protocol/handler.rs` | Request handling |\n| `src/storage/persist/mod.rs` | FilePersist, WAL, batches |\n| `src/bloom_filter.rs` | Bloom filter implementation |\n| `src/hash_index.rs` | Hash index with Bloom acceleration |\n| `src/statistics.rs` | Statistics collection and estimation |\n| `src/ir/mod.rs` | Intermediate Representation nodes |\n| `src/join_planning/mod.rs` | Join order optimization |\n| `src/sip_rewriting/mod.rs` | Sideways Information Passing |\n| `src/subplan_sharing/mod.rs` | Common subexpression elimination |\n\n---\n\n## 14. Architectural Patterns\n\n### 14.1 Arc-Wrapped Data for Sharing\n\nAll persistent data wrapped in Arc for O(1) cloning:\n```rust\ninput_tuples: Arc\u003cHashMap\u003cString, Vec\u003cTuple\u003e\u003e\u003e\nrules: Arc\u003cVec\u003cRule\u003e\u003e\nmaterialized_relations: Arc\u003cHashSet\u003cString\u003e\u003e\n```\n\n### 14.2 ArcSwap for Atomic Publishing\n\n```rust\nself.snapshot.store(Arc::new(new_snapshot));  // O(1) atomic swap\n```\n\n### 14.3 Fire-and-Forget Shadow Writes\n\n```rust\ndd.insert(relation, tuples, time)?;  // Returns immediately\n// DD processes asynchronously\n```\n\n### 14.4 Lazy Time Advancement\n\n```rust\nmax_write_time.store(time, Ordering::Relaxed);  // Track writes\n// Only advance on read: max_write_time + 1\n```\n\n### 14.5 Atomic Cascade Invalidation\n\n```rust\n// Compute invalidation set (read-only)\nlet to_invalidate = self.compute_invalidation_set(base_relation);\n\n// Bump version\n*version += 1;\n\n// Apply all invalidations atomically\nfor rel in \u0026to_invalidate {\n    mat.invalidate();\n}\n```\n\n### 14.6 Session Isolation via Cloning\n\n```rust\nlet mut isolated = (*snapshot.input_tuples).clone();\nisolated.insert(session_fact);\n// Execute against isolated copy\n```\n\n---\n\n## 15. Summary\n\nInputLayer's architecture provides:\n\n| Capability | Implementation |\n|-----------|----------------|\n| **Incremental computation** | DDComputation with persistent arrangements |\n| **Lock-free reads** | ArcSwap snapshot system |\n| **Concurrent writes** | DashMap + per-KG locking |\n| **Rule materialization** | DerivedRelationsManager with auto-rematerialization |\n| **Schema isolation** | Per-KG SchemaCatalog |\n| **Session isolation** | Cloned snapshots for ephemeral data |\n| **Parallel execution** | Rayon-based multi-worker batch queries |\n| **Durability** | WAL + Parquet batch files |\n| **Consistency** | Frontier tracking, atomic cascade invalidation |\n\n**Test Coverage**: ~3107 unit tests + ~1121 snapshot tests = ~4228 total, all passing.\n\n**HNSW Readiness**: All prerequisites complete. Indexes can attach as arrangement sinks."])</script><script>self.__next_f.push([1,"5:[\"$\",\"$Le\",null,{\"page\":{\"title\":\"InputLayer Architecture\",\"content\":\"$f\",\"toc\":[{\"level\":2,\"text\":\"Overview\",\"id\":\"overview\"},{\"level\":2,\"text\":\"1. Architecture Overview\",\"id\":\"1-architecture-overview\"},{\"level\":2,\"text\":\"2. Core Components\",\"id\":\"2-core-components\"},{\"level\":3,\"text\":\"2.1 StorageEngine\",\"id\":\"21-storageengine\"},{\"level\":3,\"text\":\"2.2 KnowledgeGraph\",\"id\":\"22-knowledgegraph\"},{\"level\":3,\"text\":\"2.3 KnowledgeGraphSnapshot\",\"id\":\"23-knowledgegraphsnapshot\"},{\"level\":3,\"text\":\"2.4 DDComputation\",\"id\":\"24-ddcomputation\"},{\"level\":3,\"text\":\"2.5 DerivedRelationsManager\",\"id\":\"25-derivedrelationsmanager\"},{\"level\":2,\"text\":\"3. Data Flow Paths\",\"id\":\"3-data-flow-paths\"},{\"level\":3,\"text\":\"3.1 Write Path\",\"id\":\"31-write-path\"},{\"level\":3,\"text\":\"3.2 Read Path (Query)\",\"id\":\"32-read-path-query\"},{\"level\":3,\"text\":\"3.3 Materialization Flow\",\"id\":\"33-materialization-flow\"},{\"level\":2,\"text\":\"4. Consistency Guarantees\",\"id\":\"4-consistency-guarantees\"},{\"level\":3,\"text\":\"4.1 Snapshot Consistency\",\"id\":\"41-snapshot-consistency\"},{\"level\":3,\"text\":\"4.2 Write Consistency\",\"id\":\"42-write-consistency\"},{\"level\":3,\"text\":\"4.3 Read-After-Write Consistency\",\"id\":\"43-read-after-write-consistency\"},{\"level\":3,\"text\":\"4.4 Session Isolation\",\"id\":\"44-session-isolation\"},{\"level\":2,\"text\":\"5. Rule System\",\"id\":\"5-rule-system\"},{\"level\":3,\"text\":\"5.1 Persistent Rules (+ prefix)\",\"id\":\"51-persistent-rules-prefix\"},{\"level\":3,\"text\":\"5.2 Session Rules (no prefix)\",\"id\":\"52-session-rules-no-prefix\"},{\"level\":3,\"text\":\"5.3 Rule Validation\",\"id\":\"53-rule-validation\"},{\"level\":2,\"text\":\"6. Data Types\",\"id\":\"6-data-types\"},{\"level\":3,\"text\":\"6.1 Unified Tuple Format\",\"id\":\"61-unified-tuple-format\"},{\"level\":3,\"text\":\"6.2 Abomonation Implementation\",\"id\":\"62-abomonation-implementation\"},{\"level\":3,\"text\":\"6.3 AST Display Implementations\",\"id\":\"63-ast-display-implementations\"},{\"level\":2,\"text\":\"7. Execution Model\",\"id\":\"7-execution-model\"},{\"level\":3,\"text\":\"7.1 Batch Execution (CodeGenerator)\",\"id\":\"71-batch-execution-codegenerator\"},{\"level\":3,\"text\":\"7.2 Incremental Execution (DDComputation)\",\"id\":\"72-incremental-execution-ddcomputation\"},{\"level\":2,\"text\":\"8. Persistence Layer\",\"id\":\"8-persistence-layer\"},{\"level\":3,\"text\":\"8.1 WAL (Write-Ahead Log)\",\"id\":\"81-wal-write-ahead-log\"},{\"level\":3,\"text\":\"8.2 Batch Files (Parquet)\",\"id\":\"82-batch-files-parquet\"},{\"level\":3,\"text\":\"8.3 Recovery Sequence\",\"id\":\"83-recovery-sequence\"},{\"level\":2,\"text\":\"9. Protocol Layer\",\"id\":\"9-protocol-layer\"},{\"level\":3,\"text\":\"9.1 Handler\",\"id\":\"91-handler\"},{\"level\":3,\"text\":\"9.2 Statement Types\",\"id\":\"92-statement-types\"},{\"level\":2,\"text\":\"10. HNSW Indexing Readiness\",\"id\":\"10-hnsw-indexing-readiness\"},{\"level\":3,\"text\":\"10.1 Prerequisites (All Complete)\",\"id\":\"101-prerequisites-all-complete\"},{\"level\":3,\"text\":\"10.2 HNSW Integration Points\",\"id\":\"102-hnsw-integration-points\"},{\"level\":3,\"text\":\"10.3 Required Extensions for HNSW\",\"id\":\"103-required-extensions-for-hnsw\"},{\"level\":2,\"text\":\"11. Configuration\",\"id\":\"11-configuration\"},{\"level\":3,\"text\":\"11.1 Performance Configuration\",\"id\":\"111-performance-configuration\"},{\"level\":3,\"text\":\"11.2 Storage Configuration\",\"id\":\"112-storage-configuration\"},{\"level\":3,\"text\":\"11.3 Environment Variables\",\"id\":\"113-environment-variables\"},{\"level\":2,\"text\":\"12. Query Optimization\",\"id\":\"12-query-optimization\"},{\"level\":3,\"text\":\"12.1 Optimization Modules\",\"id\":\"121-optimization-modules\"},{\"level\":3,\"text\":\"12.2 Bloom Filter\",\"id\":\"122-bloom-filter\"},{\"level\":3,\"text\":\"12.3 Hash Index\",\"id\":\"123-hash-index\"},{\"level\":3,\"text\":\"12.4 Statistics Manager\",\"id\":\"124-statistics-manager\"},{\"level\":3,\"text\":\"12.5 BloomSemijoin IR Node\",\"id\":\"125-bloomsemijoin-ir-node\"},{\"level\":2,\"text\":\"13. File Reference\",\"id\":\"13-file-reference\"},{\"level\":2,\"text\":\"14. Architectural Patterns\",\"id\":\"14-architectural-patterns\"},{\"level\":3,\"text\":\"14.1 Arc-Wrapped Data for Sharing\",\"id\":\"141-arc-wrapped-data-for-sharing\"},{\"level\":3,\"text\":\"14.2 ArcSwap for Atomic Publishing\",\"id\":\"142-arcswap-for-atomic-publishing\"},{\"level\":3,\"text\":\"14.3 Fire-and-Forget Shadow Writes\",\"id\":\"143-fire-and-forget-shadow-writes\"},{\"level\":3,\"text\":\"14.4 Lazy Time Advancement\",\"id\":\"144-lazy-time-advancement\"},{\"level\":3,\"text\":\"14.5 Atomic Cascade Invalidation\",\"id\":\"145-atomic-cascade-invalidation\"},{\"level\":3,\"text\":\"14.6 Session Isolation via Cloning\",\"id\":\"146-session-isolation-via-cloning\"},{\"level\":2,\"text\":\"15. Summary\",\"id\":\"15-summary\"}]},\"slugKey\":\"internals/architecture\"}]\n"])</script><script>self.__next_f.push([1,"a:[[\"$\",\"meta\",\"0\",{\"charSet\":\"utf-8\"}],[\"$\",\"meta\",\"1\",{\"name\":\"viewport\",\"content\":\"width=device-width, initial-scale=1\"}]]\n"])</script><script>self.__next_f.push([1,"10:I[6869,[],\"IconMark\"]\nc:[[\"$\",\"title\",\"0\",{\"children\":\"InputLayer - A symbolic reasoning engine for AI agents\"}],[\"$\",\"meta\",\"1\",{\"name\":\"description\",\"content\":\"Store facts, define rules, and derive everything that logically follows. Vector search, graph traversal, and incremental computation in one system.\"}],[\"$\",\"link\",\"2\",{\"rel\":\"icon\",\"href\":\"/icon.svg\"}],[\"$\",\"$L10\",\"3\",{}]]\n8:null\n"])</script></body></html>